/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/model/Model','sap/ui/model/odata/ODataUtils','sap/ui/model/odata/CountMode','sap/ui/model/odata/UpdateMethod','sap/ui/model/odata/OperationMode','./ODataContextBinding','./ODataListBinding','sap/ui/model/odata/ODataMetadata','sap/ui/model/odata/ODataPropertyBinding','./ODataTreeBinding','sap/ui/model/odata/ODataMetaModel','sap/ui/core/message/MessageParser','sap/ui/model/odata/ODataMessageParser','sap/ui/thirdparty/URI','sap/ui/thirdparty/datajs'],function(q,M,O,C,U,a,b,c,d,e,f,g,h,k,l,m){"use strict";var n=M.extend("sap.ui.model.odata.v2.ODataModel",{constructor:function(s,p){M.apply(this,arguments);var u,P,H,t,w,i,j,r,A,L,D,o,v,x,S,y,z,J,B,E,F,G=this;if(typeof(s)==="object"){p=s;s=p.serviceUrl;}if(p){u=p.user;P=p.password;H=p.headers;t=p.tokenHandling;w=p.withCredentials;i=p.maxDataServiceVersion;j=p.useBatch;r=p.refreshAfterChange;A=p.annotationURI;L=p.loadAnnotationsJoined;o=p.defaultBindingMode;D=p.defaultCountMode;v=p.defaultOperationMode;x=p.metadataNamespaces;S=p.serviceUrlParams;y=p.metadataUrlParams;J=p.json;B=p.messageParser;E=p.skipMetadataAnnotationParsing;F=p.defaultUpdateMethod;}this.mSupportedBindingModes={"OneWay":true,"OneTime":true,"TwoWay":true};this.sDefaultBindingMode=o||sap.ui.model.BindingMode.OneWay;this.bJSON=J!==false;this.aPendingRequestHandles=[];this.aCallAfterUpdate=[];this.mRequests={};this.mDeferredRequests={};this.mChangedEntities={};this.mChangeHandles={};this.mDeferredBatchGroups={};this.mChangeBatchGroups={'*':{batchGroupId:undefined,single:true}};this.sDefaultUpdateMethod=F||sap.ui.model.odata.UpdateMethod.Merge;this.bTokenHandling=t!==false;this.bWithCredentials=w===true;this.bUseBatch=j!==false;this.bRefreshAfterChange=r!==false;this.sMaxDataServiceVersion=i;this.bLoadMetadataAsync=true;this.bLoadAnnotationsJoined=L!==false;this.sAnnotationURI=A;this.sDefaultCountMode=D||C.Request;this.sDefaultOperationMode=v||a.Server;this.oMetadataLoadEvent=null;this.oMetadataFailedEvent=null;this.sRefreshBatchGroupId=undefined;this.bIncludeInCurrentBatch=false;this.bSkipMetadataAnnotationParsing=E;if(B){B.setProcessor(this);}this.oMessageParser=B;this.sDefaultChangeBatchGroup="changes";this.setDeferredBatchGroups([this.sDefaultChangeBatchGroup]);this.setChangeBatchGroups({"*":{batchGroupId:this.sDefaultChangeBatchGroup}});this.oData={};this.oMetadata=null;this.oAnnotations=null;this.aUrlParams=[];this.sServiceUrl=s;var I=s.split("?");if(I.length>1){this.sServiceUrl=I[0];if(I[1]){this.aUrlParams.push(I[1]);}}this.sServiceUrl=this.sServiceUrl.replace(/\/$/,"");this.sUser=u;this.sPassword=P;if(sap.ui.getCore().getConfiguration().getStatistics()){this.aUrlParams.push("sap-statistics=true");}this.oHeaders={};this.setHeaders(H);this.oServiceData=n.mServiceData[this.sServiceUrl];if(!this.oServiceData){n.mServiceData[this.sServiceUrl]={};this.oServiceData=n.mServiceData[this.sServiceUrl];}if(!this.oServiceData.oMetadata){z=O._createUrlParamsArray(y);this.oMetadata=new sap.ui.model.odata.ODataMetadata(this._createRequestUrl("/$metadata",undefined,z),{async:this.bLoadMetadataAsync,user:this.sUser,password:this.sPassword,headers:this.mCustomHeaders,namespaces:x,withCredentials:this.bWithCredentials});this.oServiceData.oMetadata=this.oMetadata;}else{this.oMetadata=this.oServiceData.oMetadata;}this.pAnnotationsLoaded=this.oMetadata.loaded();if(this.sAnnotationURI||!this.bSkipMetadataAnnotationParsing){var K=this._getAnnotationParser();if(!this.bSkipMetadataAnnotationParsing){this.pAnnotationsLoaded=this.oMetadata.loaded().then(function(N){return G.addAnnotationXML(N["metadataString"]);});}if(this.sAnnotationURI){this.pAnnotationsLoaded=Promise.all([this.pAnnotationsLoaded,K.addUrl(this.sAnnotationURI)]);}}if(S){this.aUrlParams=this.aUrlParams.concat(O._createUrlParamsArray(S));}this.onMetadataLoaded=function(N){G._initializeMetadata();};this.onMetadataFailed=function(N){G.fireMetadataFailed(N.getParameters());};if(!this.oMetadata.isLoaded()){this.oMetadata.attachLoaded(this.onMetadataLoaded);this.oMetadata.attachFailed(this.onMetadataFailed);}if(this.oMetadata.isFailed()){this.refreshMetadata();}if(this.oMetadata.isLoaded()){this._initializeMetadata(true);}if(this.bJSON){if(this.sMaxDataServiceVersion==="3.0"){this.oHeaders["Accept"]="application/json;odata=fullmetadata";}else{this.oHeaders["Accept"]="application/json";}}else{this.oHeaders["Accept"]="application/atom+xml,application/atomsvc+xml,application/xml";}if(this.bTokenHandling&&this.oServiceData.securityToken){this.oHeaders["x-csrf-token"]=this.oServiceData.securityToken;}this.oHeaders["Accept-Language"]=sap.ui.getCore().getConfiguration().getLanguage();this.oHeaders["DataServiceVersion"]="2.0";this.oHeaders["MaxDataServiceVersion"]="2.0";if(this.sMaxDataServiceVersion){this.oHeaders["MaxDataServiceVersion"]=this.sMaxDataServiceVersion;}},metadata:{publicMethods:["read","create","update","remove","submitChanges","getServiceMetadata","metadataLoaded","hasPendingChanges","refresh","refreshMetadata","resetChanges","setDefaultCountMode","setDefaultBindingMode","getDefaultBindingMode","getDefaultCountMode","setProperty","getSecurityToken","refreshSecurityToken","setHeaders","getHeaders","setUseBatch","setDeferredBatchGroups","getDeferredBatchGroups","setChangeBatchGroups","getChangeBatchGroups"]}});n.M_EVENTS={RejectChange:"rejectChange",MetadataLoaded:"metadataLoaded",MetadataFailed:"metadataFailed",AnnotationsLoaded:"annotationsLoaded",AnnotationsFailed:"annotationsFailed",BatchRequestFailed:"batchRequestFailed",BatchRequestSent:"batchRequestSent",BatchRequestCompleted:"batchRequestCompleted"};n.prototype.attachBatchRequestFailed=function(D,F,L){this.attachEvent("batchRequestFailed",D,F,L);return this;};n.prototype.detachBatchRequestFailed=function(F,L){this.detachEvent("batchRequestFailed",F,L);return this;};n.prototype.fireBatchRequestFailed=function(A){this.fireEvent("batchRequestFailed",A);return this;};n.prototype.attachBatchRequestSent=function(D,F,L){this.attachEvent("batchRequestSent",D,F,L);return this;};n.prototype.detachBatchRequestSent=function(F,L){this.detachEvent("batchRequestSent",F,L);return this;};n.prototype.fireBatchRequestSent=function(A){this.fireEvent("batchRequestSent",A);return this;};n.prototype.attachBatchRequestCompleted=function(D,F,L){this.attachEvent("batchRequestCompleted",D,F,L);return this;};n.prototype.detachBatchRequestCompleted=function(F,L){this.detachEvent("batchRequestCompleted",F,L);return this;};n.prototype.fireBatchRequestCompleted=function(A){this.fireEvent("batchRequestCompleted",A);return this;};n.mServiceData={};n.prototype.fireRejectChange=function(A){this.fireEvent("rejectChange",A);return this;};n.prototype.attachRejectChange=function(D,F,L){this.attachEvent("rejectChange",D,F,L);return this;};n.prototype.detachRejectChange=function(F,L){this.detachEvent("rejectChange",F,L);return this;};n.prototype._initializeMetadata=function(D){var t=this;this.bUseBatch=this.bUseBatch||this.oMetadata.getUseBatch();var i=function(I,j){if(j){t.metadataLoadEvent=q.sap.delayedCall(0,t,i,[t.bLoadMetadataAsync]);}else{if(I){t.initialize();}t.fireMetadataLoaded({metadata:t.oMetadata});q.sap.log.debug(t+" - metadataloaded fired");}};if(this.bLoadMetadataAsync&&this.sAnnotationURI&&this.bLoadAnnotationsJoined){if(this.oAnnotations&&this.oAnnotations.bInitialized){i(true);}else{this.oAnnotations.attachLoaded(function(){i(true);},this);}}else{i(this.bLoadMetadataAsync,D);}};n.prototype.refreshMetadata=function(){if(this.oMetadata&&this.oMetadata.refresh){return this.oMetadata.refresh();}};n.prototype.fireAnnotationsLoaded=function(A){this.fireEvent("annotationsLoaded",A);return this;};n.prototype.attachAnnotationsLoaded=function(D,F,L){this.attachEvent("annotationsLoaded",D,F,L);return this;};n.prototype.detachAnnotationsLoaded=function(F,L){this.detachEvent("annotationsLoaded",F,L);return this;};n.prototype.fireAnnotationsFailed=function(A){this.fireEvent("annotationsFailed",A);q.sap.log.debug(this+" - annotationsfailed fired");return this;};n.prototype.attachAnnotationsFailed=function(D,F,L){this.attachEvent("annotationsFailed",D,F,L);return this;};n.prototype.detachAnnotationsFailed=function(F,L){this.detachEvent("annotationsFailed",F,L);return this;};n.prototype.fireMetadataLoaded=function(A){this.fireEvent("metadataLoaded",A);return this;};n.prototype.attachMetadataLoaded=function(D,F,L){this.attachEvent("metadataLoaded",D,F,L);return this;};n.prototype.detachMetadataLoaded=function(F,L){this.detachEvent("metadataLoaded",F,L);return this;};n.prototype.fireMetadataFailed=function(A){this.fireEvent("metadataFailed",A);return this;};n.prototype.attachMetadataFailed=function(D,F,L){this.attachEvent("metadataFailed",D,F,L);return this;};n.prototype.detachMetadataFailed=function(F,L){this.detachEvent("metadataFailed",F,L);return this;};n.prototype._createEventInfo=function(r,R,B){var E={};E.url=r.requestUri;E.method=r.method;E.async=r.async;E.headers=r.headers;if(B){E.requests=[];for(var i=0;i<B.length;i++){var o={};if(q.isArray(B[i])){var p=B[i];for(var j=0;j<p.length;j++){var r=p[j].request;var I=B[i][j].response;o={};o.url=r.requestUri;o.method=r.method;o.headers=r.headers;if(I){o.response={};if(r._aborted){o.success=false;o.response.statusCode=0;o.response.statusText="abort";}else{o.success=true;if(I.message){o.response.message=I.message;I=I.response;o.response.responseText=I.body;o.success=false;}o.response.headers=I.headers;o.response.statusCode=I.statusCode;o.response.statusText=I.statusText;}}E.requests.push(o);}}else{var r=B[i].request;var I=B[i].response;o.url=r.requestUri;o.method=r.method;o.headers=r.headers;if(I){o.response={};if(r._aborted){o.success=false;o.response.statusCode=0;o.response.statusText="abort";}else{o.success=true;if(I.message){o.response.message=I.message;I=I.response;o.response.responseText=I.body;o.success=false;}o.response.headers=I.headers;o.response.statusCode=I.statusCode;o.response.statusText=I.statusText;}}E.requests.push(o);}}}if(R){E.response={};E.success=true;if(R.message){E.response.message=R.message;E.success=false;}if(R.response){R=R.response;}if(R&&R.statusCode!=undefined){E.response.headers=R.headers;E.response.statusCode=R.statusCode;E.response.statusText=R.statusText;E.response.responseText=R.body!==undefined?R.body:R.responseText;}}E.ID=r.requestID;return E;};n.prototype._createRequestID=function(){var r;r=q.sap.uid();return r;};n.prototype._createRequestUrl=function(p,o,u,B){var N,A=[],s="";N=this._normalizePath(p,o);if(!B){s=this.sServiceUrl+N;}else{s=N.substr(N.indexOf('/')+1);}if(this.aUrlParams){A=A.concat(this.aUrlParams);}if(u){A=A.concat(u);}if(A&&A.length>0){s+="?"+A.join("&");}return s;};n.prototype._importData=function(D,j){var t=this,L,K,r,E;if(D.results){L=[];q.each(D.results,function(i,o){var K=t._importData(o,j);if(K){L.push(K);}});return L;}else{K=this._getKey(D);if(!K){return K;}E=this.oData[K];if(!E){E=D;this.oData[K]=E;}q.each(D,function(N,p){if(p&&(p.__metadata&&p.__metadata.uri||p.results)&&!p.__deferred){r=t._importData(p,j);if(q.isArray(r)){E[N]={__list:r};}else{E[N]={__ref:r};}}else if(!p||!p.__deferred){E[N]=p;}});j[K]=true;return K;}};n.prototype._removeReferences=function(D){var t=this,L;if(D.results){L=[];q.each(D.results,function(i,j){L.push(t._removeReferences(j));});return L;}else{q.each(D,function(p,o){if(o){if(o["__ref"]||o["__list"]){delete D[p];}}});return D;}};n.prototype._restoreReferences=function(D){var t=this,L,r=[];if(D.results){L=[];q.each(D.results,function(i,j){L.push(t._restoreReferences(j));});return L;}else{q.each(D,function(p,o){if(o&&o["__ref"]){var i=t._getObject("/"+o["__ref"]);if(i){delete o["__ref"];D[p]=i;t._restoreReferences(i);}}else if(o&&o["__list"]){q.each(o["__list"],function(j,E){var i=t._getObject("/"+o["__list"][j]);if(i){r.push(i);t._restoreReferences(i);}});delete o["__list"];o.results=r;r=[];}});return D;}};n.prototype.removeData=function(){this.oData={};};n.prototype.initialize=function(){var B=this.aBindings.slice(0);q.each(B,function(i,o){o.initialize();});};n.prototype.refresh=function(F,r,B){if(typeof F==="string"){B=F;F=false;r=false;}if(r){this.removeData();}this._refresh(F,B);};n.prototype._refresh=function(F,B,i,E){var j=this.aBindings.slice(0);this.sRefreshBatchGroupId=B;q.each(j,function(I,o){o._refresh(F,i,E);});this.sRefreshBatchGroupId=undefined;};n.prototype.checkUpdate=function(F,A,j){if(A){if(!this.sUpdateTimer){this.sUpdateTimer=q.sap.delayedCall(0,this,function(){this.checkUpdate(F,false,j);});}return;}if(this.sUpdateTimer){q.sap.clearDelayedCall(this.sUpdateTimer);this.sUpdateTimer=null;}var B=this.aBindings.slice(0);q.each(B,function(I,o){o.checkUpdate(F,j);});for(var i=0;i<this.aCallAfterUpdate.length;i++){this.aCallAfterUpdate[i]();}this.aCallAfterUpdate=[];};n.prototype.bindProperty=function(p,o,P){var B=new e(this,p,o,P);return B;};n.prototype.bindList=function(p,o,s,F,P){var B=new c(this,p,o,s,F,P);return B;};n.prototype.bindTree=function(p,o,F,P,s){var B=new f(this,p,o,F,P,s);return B;};n.prototype.createBindingContext=function(p,o,P,i,r){var F=this.resolve(p,o);r=!!r;if(typeof o=="function"){i=o;o=null;}if(typeof P=="function"){i=P;P=null;}if(!F){if(i){i(null);}return null;}var D=this._getObject(p,o),K,N,B,t=this;if(!r){r=this._isReloadNeeded(F,D,P);}if(!r){K=this._getKey(D);N=this.getContext('/'+K);if(i){i(N);}return N;}if(i){var I=!q.sap.startsWith(p,"/");if(F){var j=[],s=this.createCustomParams(P);if(s){j.push(s);}if(P&&P.batchGroupId){B=P.batchGroupId;}var u=function(D){K=D?t._getKey(D):undefined;if(K&&o&&I){var w=o.getPath();w=w.substr(1);if(t.oData[w]){t.oData[w][p]={__ref:K};}}N=t.getContext('/'+K);i(N);};var v=function(E){if(E.statusCode=='404'&&o&&I){var w=o.getPath();w=w.substr(1);if(t.oData[w]){t.oData[w][p]={__ref:null};}}i(null);};this.read(F,{batchGroupId:B,urlParameters:j,success:u,error:v});}else{i(null);}}};n.prototype._isReloadNeeded=function(F,D,p){var N,j=[],s,S=[],i;if(!F){return false;}if(!D){return true;}if(p&&p["expand"]){N=p["expand"].replace(/\s/g,"");j=N.split(',');}if(j){for(i=0;i<j.length;i++){var o=j[i].indexOf("/");if(o!==-1){var r=j[i].slice(0,o);var t=j[i].slice(o+1);j[i]=[r,t];}}}for(i=0;i<j.length;i++){var u=j[i];if(q.isArray(u)){var v=D[u[0]];var w=u[1];if(!v||(v&&v.__deferred)){return true;}else{if(v){var P,x,R;if(v.__list&&v.__list.length>0){for(var y=0;y<v.__list.length;y++){P="/"+v.__list[y];x=this.getObject(P);R=this._isReloadNeeded(P,x,{expand:w});if(R){return true;}}}else if(v.__ref){P="/"+v.__ref;x=this.getObject(P);R=this._isReloadNeeded(P,x,{expand:w});if(R){return true;}}}}}else{if(D[u]===undefined||(D[u]&&D[u].__deferred)){return true;}}}if(p&&p["select"]){s=p["select"].replace(/\s/g,"");S=s.split(',');}for(i=0;i<S.length;i++){if(D[S[i]]===undefined){return true;}}if(S.length===0){var E=this.oMetadata._getEntityTypeByPath(F);if(!E){return false;}else{for(i=0;i<E.property.length;i++){if(D[E.property[i].name]===undefined){return true;}}}}return false;};n.prototype.createCustomParams=function(p){var i=[],j,s={expand:true,select:true};for(var N in p){if(N in s){i.push("$"+N+"="+q.sap.encodeURL(p[N]));}if(N==="custom"){j=p[N];for(N in j){if(N.indexOf("$")===0){q.sap.log.warning(this+" - Trying to set OData parameter '"+N+"' as custom query option!");}else{i.push(N+"="+q.sap.encodeURL(j[N]));}}}}return i.join("&");};n.prototype.bindContext=function(p,o,P){var B=new b(this,p,o,P);return B;};n.prototype.setDefaultCountMode=function(s){this.sDefaultCountMode=s;};n.prototype.getDefaultCountMode=function(){return this.sDefaultCountMode;};n.prototype._getKey=function(o){var K,u;if(o instanceof sap.ui.model.Context){K=o.getPath().substr(1);}else if(o&&o.__metadata&&o.__metadata.uri){u=o.__metadata.uri;K=u.substr(u.lastIndexOf("/")+1);}return K;};n.prototype.getKey=function(o){return this._getKey(o);};n.prototype.createKey=function(s,K){var E=this.oMetadata._getEntityTypeByPath(s),j=s,t=this,N,p;j+="(";if(E.key.propertyRef.length===1){N=E.key.propertyRef[0].name;p=this.oMetadata._getPropertyMetadata(E,N);j+=O.formatValue(K[N],p.type);}else{q.each(E.key.propertyRef,function(i,P){if(i>0){j+=",";}N=P.name;p=t.oMetadata._getPropertyMetadata(E,N);j+=N;j+="=";j+=O.formatValue(K[N],p.type);});}j+=")";return j;};n.prototype.getProperty=function(p,o,i){var v=this._getObject(p,o);if(!i){return v;}if(!q.isPlainObject(v)){return v;}v=q.sap.extend(true,{},v);if(i===true){return this._restoreReferences(v);}else{return this._removeReferences(v);}};n.prototype._getObject=function(p,o){var N=this.isLegacySyntax()?this.oData:null,r=this.resolve(p,o),s,D,i,j,K,t;if(this.oMetadata&&r&&r.indexOf('/#')>-1){s=r.indexOf('/##');if(s>=0){t=this.getMetaModel();if(!this.bMetaModelLoaded){return null;}D=r.substr(0,s);i=r.substr(s+3);j=t.getMetaContext(D);N=t.getProperty(i,j);}else{N=this.oMetadata._getAnnotation(r);}}else{if(o){K=o.getPath();K=K.substr(1);N=this.mChangedEntities[K]?this.mChangedEntities[K]:this.oData[K];}if(!p){return N;}var P=p.split("/"),I=0;if(!P[0]){I++;if(this.mChangedEntities[P[I]]){N=this.mChangedEntities;}else{N=this.oData;}}while(N&&P[I]){N=N[P[I]];if(N){if(N.__ref){N=this.oData[N.__ref];}else if(N.__list){N=N.__list;}else if(N.__deferred){N=undefined;}}I++;}}return N;};n.prototype.updateSecurityToken=function(){if(this.bTokenHandling){if(!this.oServiceData.securityToken){this.refreshSecurityToken();}if(this.bTokenHandling){this.oHeaders["x-csrf-token"]=this.oServiceData.securityToken;}}};n.prototype.resetSecurityToken=function(){delete this.oServiceData.securityToken;delete this.oHeaders["x-csrf-token"];};n.prototype.getSecurityToken=function(){var t=this.oServiceData.securityToken;if(!t){this.refreshSecurityToken();t=this.oServiceData.securityToken;}return t;};n.prototype.refreshSecurityToken=function(s,E){var t=this,u,T;u=this._createRequestUrl("/");var r=this._createRequest(u,"GET",this._getHeaders(),null,null,false);r.headers["x-csrf-token"]="Fetch";function _(D,R){if(R){T=t._getHeader("x-csrf-token",R.headers);if(T){t.oServiceData.securityToken=T;t.oHeaders["x-csrf-token"]=T;}else{t.resetSecurityToken();t.bTokenHandling=false;}}if(s){s(D,R);}}function i(o){t.resetSecurityToken();t.bTokenHandling=false;t._handleError(o);if(E){E(o);}}return this._request(r,_,i,undefined,undefined,this.getServiceMetadata());};n.prototype._submitRequest=function(r,s,E){var t=this,H;function _(D,R){if(s){s(D,R);}}function i(o){if(t.bTokenHandling&&o.response){var T=t._getHeader("x-csrf-token",o.response.headers);if(!r.bTokenReset&&o.response.statusCode=='403'&&T&&T.toLowerCase()==="required"){t.resetSecurityToken();r.bTokenReset=true;j();return;}}if(E){E(o);}}function j(){if(t.bTokenHandling&&r.method!=="GET"){t.updateSecurityToken();if(t.bTokenHandling){r.headers["x-csrf-token"]=t.oServiceData.securityToken;}}H=t._getODataHandler(r.requestUri);return t._request(r,_,i,H,undefined,t.getServiceMetadata());}return j();};n.prototype._submitSingleRequest=function(r,s,E){var t=this,R,i={},G={},j={},o;var p=function(D,v){var S=function(D,v){if(s){s(D,v);}if(r.requestUri.indexOf("$count")===-1){t.checkUpdate(false,false,G);if(t._isRefreshNeeded(r,v)){t._refresh(false,undefined,i,j);}}t._updateChangedEntities(i);};t._processSuccess(r,v,S,G,i,j);};var u=function(v){if(v.message=="Request aborted"){t._processAborted(r,v,E);}else{t._processError(r,v,E);}};R=this._submitRequest(r,p,u);o=this._createEventInfo(r);this.fireRequestSent(o);return R;};n.prototype._submitBatchRequest=function(B,r,s,E){var t=this;var o=function(D,v){var w,x,y,z=D.__batchResponses,A,F={},G={},H={};if(z){var i,j;for(i=0;i<z.length;i++){w=z[i];if(q.isArray(r[i])){if(w.message){for(j=0;j<r[i].length;j++){x=r[i][j];if(x.request._aborted){t._processAborted(x.request,w,x.fnError);}else{t._processError(x.request,w,x.fnError);}x.response=w;}}else{y=w.__changeResponses;for(j=0;j<y.length;j++){var I=y[j];x=r[i][j];if(x.request._aborted){t._processAborted(x.request,I,x.fnError);}else if(I.message){t._processError(x.request,I,x.fnError);}else{t._processSuccess(x.request,I,x.fnSuccess,G,F,H);}x.response=I;}}}else{x=r[i];if(x.request._aborted){t._processAborted(x.request,w,x.fnError);}else if(w.message){t._processError(x.request,w,x.fnError);}else{t._processSuccess(x.request,w,x.fnSuccess,G,F,H);}x.response=w;}}t.checkUpdate(false,false,G);}if(s){s(D);}A=t._createEventInfo(B,v,r);t.fireBatchRequestCompleted(A);};var p=function(j){var v,A=R&&R.bAborted;q.each(r,function(i,w){if(q.isArray(w)){q.each(w,function(i,w){if(A){t._processAborted(w.request,j,w.fnError);}else{t._processError(w.request,j,w.fnError);}});}else{if(A){t._processAborted(w.request,j,w.fnError);}else{t._processError(w.request,j,w.fnError);}}});if(E){E(j);}v=t._createEventInfo(B,j,r);t.fireBatchRequestCompleted(v);if(!A){t.fireBatchRequestFailed(v);}};var u=function(T,B,j,r){var v;q.each(r,function(i,w){if(q.isArray(w)){q.each(w,function(i,w){v=t._createEventInfo(w.request,j);t["fireRequest"+T](v);});}else{v=t._createEventInfo(w.request,j);t["fireRequest"+T](v);}});v=t._createEventInfo(B,j,r);t["fireBatchRequest"+T](v);};var R=this._submitRequest(B,o,p);u("Sent",B,null,r);return R;};n.prototype._createBatchRequest=function(B){var u,r,o={},p={};p.__batchRequests=B;u=this.sServiceUrl+"/$batch";if(this.aUrlParams.length>0){u+="?"+this.aUrlParams.join("&");}q.extend(o,this.mCustomHeaders,this.oHeaders);delete o["Content-Type"];r={headers:o,requestUri:u,method:"POST",data:p,user:this.sUser,password:this.sPassword,async:true};r.withCredentials=this.bWithCredentials;return r;};n.prototype._pushToRequestQueue=function(r,B,s,R,S,E){var o,i=r[B];if(!i){i={};i.requests=[];r[B]=i;}if(R.method!=="GET"){if(!i.changes){i.changes={};}if(R.key&&i.map&&R.key in i.map){i.map[R.key].method=R.method;if(R.method==="PUT"){delete i.map[R.key].headers["x-http-method"];}if(i.map[R.key]._aborted){delete i.map[R.key]._aborted;}i.map[R.key].data=R.data;}else{o=i.changes[s];if(!o){o=[];i.changes[s]=o;}R._changeSetId=s;o.push({request:R,fnSuccess:S,fnError:E,changeSetId:s});if(R.key){if(!i.map){i.map={};}i.map[R.key]=R;}}}else{i.requests.push({request:R,fnSuccess:S,fnError:E});}};n.prototype._collectChangedEntities=function(G,j,E){var t=this;if(G.changes){q.each(G.changes,function(s,o){for(var i=0;i<o.length;i++){var r=o[i].request,K=r.requestUri.split('?')[0];if(r.method==="POST"){var p=t.oMetadata._getEntityTypeByPath("/"+K);if(p){E[p.entityType]=true;}}else{j[K]=true;}}});}};n.prototype._processRequestQueue=function(r,B,s,E){var t=this,R=[];if(this.oRequestTimer&&r!==this.mDeferredRequests){q.sap.clearDelayedCall(this.oRequestTimer);this.oRequestTimer=undefined;}if(this.bUseBatch){if(t.bRefreshAfterChange){q.each(r,function(G,o){if(G===B||!B){var i={},j={};t._collectChangedEntities(o,i,j);t.bIncludeInCurrentBatch=true;t._refresh(false,G,i,j);t.bIncludeInCurrentBatch=false;}});}q.each(r,function(G,o){if(G===B||!B){var j=[],p=[],u,v;if(o.changes){q.each(o.changes,function(y,z){u={__changeRequests:[]};v=[];for(var i=0;i<z.length;i++){if(z[i].request._aborted){t._processAborted(z[i].request,null,z[i].fnError);}else{if(z[i].request.data&&z[i].request.data.__metadata){delete z[i].request.data.__metadata.created;}u.__changeRequests.push(z[i].request);v.push(z[i]);}}if(u.__changeRequests&&u.__changeRequests.length>0){j.push(u);p.push(v);}});}if(o.requests){var w=o.requests;for(var i=0;i<w.length;i++){if(w[i].request._aborted){t._processAborted(w[i].request,null,w[i].fnError);}else{j.push(w[i].request);p.push(w[i]);}}}if(j.length>0){var x=t._createBatchRequest(j,true);R.push(t._submitBatchRequest(x,p,s,E));}delete r[G];}});}else{q.each(r,function(G,o){if(G===B||!B){if(o.changes){q.each(o.changes,function(p,u){for(var i=0;i<u.length;i++){if(u[i].request._aborted){t._processAborted(u[i].request,null,u[i].fnError);}else{u[i].request._handle=t._submitSingleRequest(u[i].request,u[i].fnSuccess,u[i].fnError);R.push(u[i].request._handle);}}});}if(o.requests){var j=o.requests;for(var i=0;i<j.length;i++){if(j[i].request._aborted){t._processAborted(j[i].request,null,j[i].fnError);}else{j[i].request._handle=t._submitSingleRequest(j[i].request,j[i].fnSuccess,j[i].fnError);R.push(j[i].request._handle);}}}delete r[G];}});}return R.length==1?R[0]:R;};n.prototype._processSuccess=function(r,R,s,G,i,E){var o=R.data,j,u,p,P,t,v=this;j=!(R.statusCode===204||R.statusCode==='204');if(j&&!o&&R){this._parseResponse(R,r,G,i);q.sap.log.fatal(this+" - No data was retrieved by service: '"+R.requestUri+"'");v.fireRequestCompleted({url:R.requestUri,type:"GET",async:R.async,info:"Accept headers:"+this.oHeaders["Accept"],infoObject:{acceptHeaders:this.oHeaders["Accept"]},success:false});return false;}if(o&&o.results&&!q.isArray(o.results)){o=o.results;}if(o&&(q.isArray(o)||typeof o=='object')){o=q.sap.extend(true,{},o);v._importData(o,G);}u=r.requestUri;p=u.replace(this.sServiceUrl,"");if(!q.sap.startsWith(p,'/')){p='/'+p;}p=this._normalizePath(p);if(!j){P=p.split("/");if(P[1]){i[P[1]]=true;var w={};w[P[1]]=true;this._updateChangedEntities(w);}if(r.method==="DELETE"){delete v.oData[P[1]];delete v.mContexts["/"+P[1]];}}if(j&&r.method==="POST"){t=this.oMetadata._getEntityTypeByPath(p);if(t){E[t.entityType]=true;}if(r.context){var K=this._getKey(o);delete this.mChangedEntities[r.context.sPath.substr(1)];delete this.oData[r.context.sPath.substr(1)];r.context.sPath='/'+K;}}this._parseResponse(R,r,G,i);this._updateETag(r,R);if(s){s(R.data,R);}var x=this._createEventInfo(r,R);this.fireRequestCompleted(x);return true;};n.prototype._processError=function(r,R,E){var o=this._handleError(R,r);if(E){E(o);}var i=this._createEventInfo(r,o);this.fireRequestCompleted(i);this.fireRequestFailed(i);};n.prototype._processAborted=function(r,R,E){var o={message:"Request aborted",statusCode:0,statusText:"abort",headers:{},responseText:""};if(E){E(o);}if(R){var i=this._createEventInfo(r,o);i.success=false;this.fireRequestCompleted(i);}};n.prototype._processChange=function(K,D,u){var p,E,s,i,j,H,r,t,o,v=this;E=this.oMetadata._getEntityTypeByPath(K);if(!u){u="MERGE";}if(D.__metadata&&D.__metadata.created){i="POST";K=D.__metadata.created.key;}else if(u==="MERGE"){i="MERGE";o=this.oData[K];}else{i="PUT";}p=q.sap.extend(true,{},D);if(p.__metadata){t=p.__metadata.type;s=p.__metadata.etag;delete p.__metadata;if(t||s){p.__metadata={};}if(t){p.__metadata.type=t;}if(s){p.__metadata.etag=s;}}if(E){var N=this.oMetadata._getNavigationPropertyNames(E);q.each(N,function(I,x){delete p[x];});}if(i==="MERGE"&&E&&o){q.each(p,function(x,y){if(x!=='__metadata'){if(q.sap.equal(o[x],y)){delete p[x];}}});var P="/"+K,w;q.each(p,function(x,y){if(x!=='__metadata'){w=v.getProperty(P+"/"+x+"/#@sap:unit");if(w){if(p[w]===undefined){p[w]=o[w];}}}});}p=this._removeReferences(p);j=this._createRequestUrl('/'+K);H=this._getHeaders();r=this._createRequest(j,i,H,p,s);if(this.bUseBatch){r.requestUri=r.requestUri.replace(this.sServiceUrl+'/','');}return r;};n.prototype._resolveGroup=function(K){var o,E,B,s;E=this.oMetadata._getEntityTypeByPath(K);if(this.mChangeBatchGroups[E.name]){o=this.mChangeBatchGroups[E.name];B=o.batchGroupId;s=o.single?q.sap.uid():o.changeSetId;}else if(this.mChangeBatchGroups['*']){o=this.mChangeBatchGroups['*'];B=o.batchGroupId;s=o.single?q.sap.uid():o.changeSetId;}return{batchGroupId:B,changeSetId:s};};n.prototype._updateETag=function(r,R){var u,E,s;u=r.requestUri.replace(this.sServiceUrl+'/','');if(!q.sap.startsWith(u,"/")){u="/"+u;}E=this._getObject(u);s=this._getHeader("etag",R.headers);if(E&&E.__metadata&&s){E.__metadata.etag=s;}};n.prototype._handleError=function(E,r){var p={},t;var s="The following problem occurred: "+E.message;p.message=E.message;if(E.response){this._parseResponse(E.response,r);if(this.bTokenHandling){t=this._getHeader("x-csrf-token",E.response.headers);if(E.response.statusCode=='403'&&t&&t.toLowerCase()==="required"){this.resetSecurityToken();}}s+=E.response.statusCode+","+E.response.statusText+","+E.response.body;p.statusCode=E.response.statusCode;p.statusText=E.response.statusText;p.headers=E.response.headers;p.responseText=E.response.body;}q.sap.log.fatal(s);return p;};n.prototype.getData=function(p,o,i){return this.getProperty(p,o,i);};n.prototype._getODataHandler=function(u){if(u.indexOf("$batch")>-1){return m.batchHandler;}else if(u.indexOf("$count")>-1){return undefined;}else if(this.bJSON){return m.jsonHandler;}else{return m.atomHandler;}};n.prototype.getETag=function(p,o,E){if(typeof p=="object"){E=p;p="";}return this._getETag(p,o,E);};n.prototype._getETag=function(p,o,D){if(!D||!D.__metadata){D=this._getObject(p,o);}if(D&&D.__metadata){return D.__metadata.etag;}return null;};n.prototype._createRequest=function(u,s,H,D,E,A){A=A!==false;if(E&&s!=="GET"){H["If-Match"]=E;}if(this.bJSON&&s!=="DELETE"&&this.sMaxDataServiceVersion==="2.0"){H["Content-Type"]="application/json";}if(u.indexOf("$count")>-1){H["Accept"]="text/plain, */*;q=0.5";}if(s==="MERGE"&&!this.bUseBatch){H["x-http-method"]="MERGE";s="POST";}var r={headers:H,requestUri:u,method:s,user:this.sUser,password:this.sPassword,async:A};if(D){r.data=D;}if(this.bWithCredentials){r.withCredentials=this.bWithCredentials;}r.requestID=this._createRequestID();return r;};n.prototype._isRefreshNeeded=function(r,R){var i=false;if(this.bRefreshAfterChange){i=true;}return i;};n.prototype._processRequest=function(p){var r,R,A=false,t=this;this.oMetadata.loaded().then(function(){R=p();if(!t.oRequestTimer){t.oRequestTimer=q.sap.delayedCall(0,t,t._processRequestQueue,[t.mRequests]);}if(A){r.abort();}});r={abort:function(){A=true;if(R){R._aborted=true;if(R._handle){R._handle.abort();}}}};return r;};n.prototype.update=function(p,D,P){var s,E,r,u,o,i,S,K,j,B,t,v,H,w,R,x={},y=this;if(P){B=P.batchGroupId;t=P.changeSetId;o=P.context;s=P.success;E=P.error;i=P.eTag;H=P.headers;v=P.urlParameters;if(P.merge!==undefined){w=P.merge?"MERGE":"PUT";}}j=O._createUrlParamsArray(v);H=this._getHeaders(H);w=w?w:this.sDefaultUpdateMethod;i=i||this._getETag(p,o,D);S=y._getObject(p,o);if(S){K=this._getKey(S);x[K]=true;}return this._processRequest(function(){u=y._createRequestUrl(p,o,j,y.bUseBatch);r=y._createRequest(u,w,H,D,i);r.keys=x;R=y.mRequests;if(B in y.mDeferredBatchGroups){R=y.mDeferredRequests;}y._pushToRequestQueue(R,B,t,r,s,E);return r;});};n.prototype.create=function(p,D,P){var r,u,E,o,s,i,j,R,H,t,v,B,w,x,y=this;if(P){o=P.context;j=P.urlParameters;s=P.success;i=P.error;B=P.batchGroupId;x=P.changeSetId;v=P.eTag;H=P.headers;}t=O._createUrlParamsArray(j);H=this._getHeaders(H);w="POST";return this._processRequest(function(){u=y._createRequestUrl(p,o,t,y.bUseBatch);r=y._createRequest(u,w,H,D,v);p=y._normalizePath(p,o);E=y.oMetadata._getEntityTypeByPath(p);r.entityTypes={};if(E){r.entityTypes[E.entityType]=true;}R=y.mRequests;if(B in y.mDeferredBatchGroups){R=y.mDeferredRequests;}y._pushToRequestQueue(R,B,x,r,s,i);return r;});};n.prototype.remove=function(p,P){var o,E,s,i,r,u,B,j,t,v,w,H,x,y,R,z=this;if(P){B=P.batchGroupId;j=P.changeSetId;o=P.context;s=P.success;i=P.error;t=P.eTag;H=P.headers;w=P.urlParameters;}x=O._createUrlParamsArray(w);H=this._getHeaders(H);y="DELETE";t=t||this._getETag(p,o);v=function(D,A){E=u.substr(u.lastIndexOf('/')+1);if(E.indexOf('?')!==-1){E=E.substr(0,E.indexOf('?'));}delete z.oData[E];delete z.mContexts["/"+E];if(s){s(D,A);}};return this._processRequest(function(){u=z._createRequestUrl(p,o,x,z.bUseBatch);r=z._createRequest(u,y,H,undefined,t);R=z.mRequests;if(B in z.mDeferredBatchGroups){R=z.mDeferredRequests;}z._pushToRequestQueue(R,B,j,r,v,i);return r;});};n.prototype.callFunction=function(F,p){var r,u,o,R,i,j,s,E,t="GET",j,I={},B,v,H,w=this;if(p){B=p.batchGroupId;v=p.changeSetId;t=p.method?p.method:t;i=p.urlParameters;s=p.success;E=p.error;H=p.headers;}if(!q.sap.startsWith(F,"/")){q.sap.log.fatal(this+" callFunction: path '"+F+"' must be absolute!");return;}H=this._getHeaders(H);return this._processRequest(function(){o=w.oMetadata._getFunctionImportMetadata(F,t);if(!o){return;}if(o.parameter!=null){q.each(i,function(P,x){var y=q.grep(o.parameter,function(z){return z.name===P&&(!z.mode||z.mode==="In");});if(y!=null&&y.length>0){I[P]=O.formatValue(x,y[0].type);}else{q.sap.log.warning(w+" - Parameter '"+P+"' is not defined for function call '"+F+"'!");}});}j=O._createUrlParamsArray(I);u=w._createRequestUrl(F,null,j,w.bUseBatch);r=w._createRequest(u,t,H,undefined);R=w.mRequests;if(B in w.mDeferredBatchGroups){R=w.mDeferredRequests;}w._pushToRequestQueue(R,B,v,r,s,E);return r;});};n.prototype.read=function(p,P){var r,u,o,i,s,E,F,S,j,t,v,N,w,H,x,B,y,R,z=this;if(P){o=P.context;i=P.urlParameters;s=P.success;E=P.error;F=P.filters;S=P.sorters;B=P.batchGroupId;H=P.headers;}if(this.sRefreshBatchGroupId){B=this.sRefreshBatchGroupId;}w=O._createUrlParamsArray(i);H=this._getHeaders(H);x="GET";y=this._getETag(p,o);function A(){t=O.createSortParams(S);if(t){w.push(t);}var T=p;var I=p.indexOf("$count");if(I!==-1){T=p.substring(0,I-1);}N=z._normalizePath(T,o);v=z.oMetadata._getEntityTypeByPath(N);j=O.createFilterParams(F,z.oMetadata,v);if(j){w.push(j);}u=z._createRequestUrl(p,o,w,z.bUseBatch);r=z._createRequest(u,x,H,null,y);R=z.mRequests;if(B in z.mDeferredBatchGroups){R=z.mDeferredRequests;}z._pushToRequestQueue(R,B,null,r,s,E);return r;}if(this.bUseBatch&&this.bIncludeInCurrentBatch){r=A();return{abort:function(){if(r){r._aborted=true;}}};}else{return this._processRequest(A);}};n.prototype.getServiceMetadata=function(){if(this.oMetadata&&this.oMetadata.isLoaded()){return this.oMetadata.getServiceMetadata();}};n.prototype.metadataLoaded=function(){return this.oMetadata.loaded();};n.prototype.getServiceAnnotations=function(){if(this.oAnnotations&&this.oAnnotations.getAnnotationsData){return this.oAnnotations.getAnnotationsData();}};n.prototype._getAnnotationParser=function(){if(!this.oAnnotations){q.sap.require("sap.ui.model.odata.ODataAnnotations");this.oAnnotations=new sap.ui.model.odata.ODataAnnotations(null,this.oMetadata,{async:this.bLoadMetadataAsync});this.oAnnotations.attachFailed(function(E){this.fireAnnotationsFailed(E.getParameters());}.bind(this));this.oAnnotations.attachLoaded(function(E){this.fireAnnotationsLoaded(E.getParameters());}.bind(this));}return this.oAnnotations;};n.prototype.addAnnotationUrl=function(u){var j=[].concat(u),o=[],A=[],E=[],t=this;q.each(j,function(i,s){var I=s.indexOf("$metadata");if(I>=0){if(I==0){s=t.sServiceUrl+'/'+s;}o.push(s);}else{A.push(s);}});return this.oMetadata._addUrl(o).then(function(p){return Promise.all(q.map(p,function(P){E=E.concat(P.entitySets);return t.addAnnotationXML(P.metadataString);}));}).then(function(){return t._getAnnotationParser().addUrl(A);}).then(function(p){return{annotations:p.annotations,entitySets:E};});};n.prototype.addAnnotationXML=function(x){return new Promise(function(r,i){this._getAnnotationParser().setXML(null,x,{success:r,error:i,fireEvents:true});}.bind(this));};n.prototype.submitChanges=function(p){var r,B,G,s,E,R,v,A=false,j,t=this;if(p){B=p.batchGroupId;s=p.success;E=p.error;if(p.merge!==undefined){j=p.merge?"MERGE":"PUT";}}if(B&&!this.mDeferredBatchGroups[B]){q.sap.log.fatal(this+" submitChanges: \""+B+"\" is not a deferred batch group!");}this.oMetadata.loaded().then(function(){q.each(t.mChangedEntities,function(K,D){G=t._resolveGroup(K);if(G.batchGroupId===B||!B){r=t._processChange(K,D,j||t.sDefaultUpdateMethod);r.key=K;if(G.batchGroupId in t.mDeferredBatchGroups){t._pushToRequestQueue(t.mDeferredRequests,G.batchGroupId,G.changeSetId,r);}}});v=t._processRequestQueue(t.mDeferredRequests,B,s,E);if(A){R.abort();}});R={abort:function(){if(v){if(q.isArray(v)){q.each(v,function(i,R){R.abort();});}else{v.abort();}}else{A=true;}}};return R;};n.prototype._updateChangedEntities=function(i){var t=this;q.each(i,function(K,j){if(K in t.mChangedEntities){var o=t._getObject('/'+K);delete t.mChangedEntities[K];var E=t._getObject('/'+K);q.sap.extend(true,E,o);}});};n.prototype.resetChanges=function(K){var t=this;if(K){q.each(K,function(i,s){if(s in t.mChangedEntities){t.mChangeHandles[s].abort();delete t.mChangeHandles[s];delete t.mChangedEntities[s];}else{q.sap.log.warning(t+" - resetChanges: "+s+" is not changed nor a valid change key!");}});}else{q.each(this.mChangedEntities,function(s,o){t.mChangeHandles[s].abort();delete t.mChangeHandles[s];delete t.mChangedEntities[s];});}this.checkUpdate();};n.prototype.setProperty=function(p,v,o,A){var P,r,R,E={},D={},s=this.resolve(p,o),j,K,G,t,u={},w;if(!s){q.sap.log.warning(this+" - TwoWay binding: path '"+p+"' not resolvable!");return false;}j=s.split("/");P=j[j.length-1];D=this._getObject(s.substr(0,s.lastIndexOf("/")));if(!D){return false;}for(var i=j.length-1;i>=0;i--){w=j.join("/");E=this._getObject(w);if(E){K=this._getKey(E);if(K){break;}}j.splice(i,1);}if(!this.mChangedEntities[K]){E=q.sap.extend(true,{},E);}this.mChangedEntities[K]=E;var x=E;j=s.substr(w.length).split("/");for(var i=1;i<j.length-1;i++){if(!x.hasOwnProperty(j[i])){x[j[i]]={};}x=x[j[i]];}x[P]=v;G=this._resolveGroup(K);r=this.mRequests;if(G.batchGroupId in this.mDeferredBatchGroups){r=this.mDeferredRequests;R=this._processChange(K,{__metadata:E.__metadata});R.key=K;}else{R=this._processChange(K,E);}if(!this.mChangeHandles[K]){t={abort:function(){R._aborted=true;}};this.mChangeHandles[K]=t;}this._pushToRequestQueue(r,G.batchGroupId,G.changeSetId,R);if(this.bUseBatch){if(!this.oRequestTimer){this.oRequestTimer=q.sap.delayedCall(0,this,this._processRequestQueue,[this.mRequests]);}}else{this._processRequestQueue(this.mRequests);}u[K]=true;this.checkUpdate(false,A,u);return true;};n.prototype._isHeaderPrivate=function(H){switch(H.toLowerCase()){case"accept":case"accept-language":case"maxdataserviceversion":case"dataserviceversion":return true;case"x-csrf-token":return this.bTokenHandling;default:return false;}return false;};n.prototype.setHeaders=function(H){var i={},t=this;this.mCustomHeaders={};if(H){q.each(H,function(s,j){if(t._isHeaderPrivate(s)){q.sap.log.warning(this+" - modifying private header: '"+s+"' not allowed!");}else{i[s]=j;}});this.mCustomHeaders=i;}};n.prototype._getHeaders=function(H){var i={},t=this;if(H){q.each(H,function(s,j){if(t._isHeaderPrivate(s)){q.sap.log.warning(this+" - modifying private header: '"+s+"' not allowed!");}else{i[s]=j;}});}return q.extend({},this.mCustomHeaders,i,this.oHeaders);};n.prototype.getHeaders=function(){return q.extend({},this.mCustomHeaders,this.oHeaders);};n.prototype._getHeader=function(H,i){var s;for(s in i){if(s.toLowerCase()===H.toLowerCase()){return i[s];}}return null;};n.prototype.hasPendingChanges=function(){return!q.isEmptyObject(this.mChangedEntities);};n.prototype.getPendingChanges=function(){return q.sap.extend(true,{},this.mChangedEntities);};n.prototype.updateBindings=function(F){this.checkUpdate(F);};n.prototype.setTokenHandlingEnabled=function(t){this.bTokenHandling=t;};n.prototype.setUseBatch=function(u){this.bUseBatch=u;};n.prototype.formatValue=function(v,t){return O.formatValue(v,t);};n.prototype.deleteCreatedEntry=function(o){if(o){var p=o.getPath();delete this.mContexts[p];if(q.sap.startsWith(p,"/")){p=p.substr(1);}this.mChangeHandles[p].abort();delete this.mChangeHandles[p];delete this.mChangedEntities[p];delete this.oData[p];}};n.prototype.createEntry=function(p,P){var s,E,r,u,j,o,K,t,B,v,R,w,H,x,y,z={},A,D="POST",F=this;if(P){y=P.properties;B=P.batchGroupId;v=P.changeSetId;o=P.context;s=P.success;E=P.error;A=P.created;j=P.eTag;H=P.headers;w=P.urlParameters;}B=B?B:this.sDefaultChangeBatchGroup;t=O._createUrlParamsArray(w);H=this._getHeaders(H);function G(){var I;if(!q.sap.startsWith(p,"/")){p="/"+p;}var J=F.oMetadata._getEntityTypeByPath(p);if(!J){return undefined;}if(typeof y==="object"&&!q.isArray(y)){z=y;}else{for(var i=0;i<J.property.length;i++){var L=J.property[i];var T=L.type.split('.');var N=q.inArray(L.name,y)>-1;if(!y||N){z[L.name]=F._createPropertyValue(T);if(N){y.splice(y.indexOf(L.name),1);}}}if(y){}}K=p.substring(1)+"('"+q.sap.uid()+"')";F.oData[K]=z;z.__metadata={type:""+J.entityType,uri:F.sServiceUrl+'/'+K,created:{key:p.substring(1)}};u=F._createRequestUrl(p,o,t,F.bUseBatch);r=F._createRequest(u,D,H,z,undefined,j);I=F.getContext("/"+K);r.context=I;r.key=K;x=F.mRequests;if(B in F.mDeferredBatchGroups){x=F.mDeferredRequests;}F._pushToRequestQueue(x,B,v,r,s,E,P);R={abort:function(){r._aborted=true;}};F.mChangeHandles[K]=R;if(F.bUseBatch){if(!F.oRequestTimer){F.oRequestTimer=q.sap.delayedCall(0,F,F._processRequestQueue,[F.mRequests]);}}else{F._processRequestQueue(F.mRequests);}return I;}if(A){this.oMetadata.loaded().then(function(){A(G());});}else if(this.oMetadata.isLoaded()){return G();}else{q.sap.log.error("Tried to use createEntry without created-callback, before metadata is available!");}};n.prototype._createPropertyValue=function(t){var N=t[0];var T=t[1];if(N.toUpperCase()!=='EDM'){var o={};var j=this.oMetadata._getObjectMetadata("complexType",T,N);for(var i=0;i<j.property.length;i++){var p=j.property[i];t=p.type.split('.');o[p.name]=this._createPropertyValue(t);}return o;}else{return this._getDefaultPropertyValue(T,N);}};n.prototype._getDefaultPropertyValue=function(t,N){return undefined;};n.prototype._normalizePath=function(p,o){if(p&&p.indexOf('?')!==-1){p=p.substr(0,p.indexOf('?'));}if(!o&&!q.sap.startsWith(p,"/")){q.sap.log.fatal(this+" path "+p+" must be absolute if no Context is set");}return this.resolve(p,o);};n.prototype.setRefreshAfterChange=function(r){this.bRefreshAfterChange=r;};n.prototype.isList=function(p,o){p=this.resolve(p,o);return p&&p.substr(p.lastIndexOf("/")).indexOf("(")===-1;};n.prototype._request=function(r,s,E,H,o,i){var R;if(this.bDestroyed){return{abort:function(){}};}var t=this;function w(j){return function(){var I=q.inArray(R,t.aPendingRequestHandles);if(I>-1){t.aPendingRequestHandles.splice(I,1);}if(!(R&&R.bSuppressErrorHandlerCall)){j.apply(this,arguments);}};}R=m.request(r,w(s||m.defaultSuccess),w(E||m.defaultError),H,o,i);if(r.async!==false){this.aPendingRequestHandles.push(R);}return R;};n.prototype.destroy=function(){M.prototype.destroy.apply(this,arguments);if(this.aPendingRequestHandles){for(var i=this.aPendingRequestHandles.length-1;i>=0;i--){var r=this.aPendingRequestHandles[i];if(r&&r.abort){r.bSuppressErrorHandlerCall=true;r.abort();}}delete this.aPendingRequestHandles;}if(this.oMetadataLoadEvent){q.sap.clearDelayedCall(this.oMetadataLoadEvent);}if(this.oMetadataFailedEvent){q.sap.clearDelayedCall(this.oMetadataFailedEvent);}if(this.oMetadata){this.oMetadata.detachLoaded(this.onMetadataLoaded);this.oMetadata.detachFailed(this.onMetadataFailed);if(!this.oMetadata.isLoaded()&&!this.oMetadata.hasListeners("loaded")){this.oMetadata.destroy();delete this.oServiceData.oMetadata;}delete this.oMetadata;}if(this.oAnnotations){this.oAnnotations.destroy();delete this.oAnnotations;}};n.prototype.setDeferredBatchGroups=function(G){var t=this;this.mDeferredBatchGroups={};q.each(G,function(i,B){t.mDeferredBatchGroups[B]=B;});};n.prototype.getDeferredBatchGroups=function(){var G=[],i=0;q.each(this.mDeferredBatchGroups,function(K,B){G[i]=B;i++;});return G;};n.prototype.setChangeBatchGroups=function(G){this.mChangeBatchGroups=G;};n.prototype.getChangeBatchGroups=function(){return this.mChangeBatchGroups;};n.prototype.setMessageParser=function(p){if(!(p instanceof h)){q.sap.log.error("Given MessageParser is not of type sap.ui.core.message.MessageParser");return;}p.setProcessor(this);this.oMessageParser=p;return this;};n.prototype._parseResponse=function(r,R,G,i){try{if(!this.oMessageParser){this.oMessageParser=new k(this.sServiceUrl,this.oMetadata);this.oMessageParser.setProcessor(this);}return this.oMessageParser.parse(r,R,G,i);}catch(j){q.sap.log.error("Error parsing OData messages: "+j);}};n.prototype.callAfterUpdate=function(F){this.aCallAfterUpdate.push(F);};n.prototype.getMetaModel=function(){var t=this;if(!this.oMetaModel){this.oMetaModel=new g(this.oMetadata,this.oAnnotations,{addAnnotationUrl:this.addAnnotationUrl.bind(this),annotationsLoadedPromise:this.pAnnotationsLoaded});this.oMetaModel.loaded().then(function(){t.bMetaModelLoaded=true;t.checkUpdate();});}return this.oMetaModel;};return n;},true);
