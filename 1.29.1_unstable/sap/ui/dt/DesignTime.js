/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','sap/ui/dt/Overlay','sap/ui/dt/OverlayRegistry','sap/ui/dt/Selection','sap/ui/dt/ElementUtil','./library'],function(M,O,a,S,E){"use strict";var D=M.extend("sap.ui.dt.DesignTime",{metadata:{library:"sap.ui.dt",properties:{selectionMode:{type:"sap.ui.dt.SelectionMode",defaultValue:sap.ui.dt.SelectionMode.Single}},associations:{rootElements:{type:"sap.ui.core.Element",multiple:true}},aggregations:{plugins:{type:"sap.ui.dt.Plugin",multiple:true}},events:{overlayCreated:{overlay:"sap.ui.dt.Overlay"},selectionChange:{type:"sap.ui.dt.Overlay[]"}}}});D.prototype.init=function(){this._oSelection=this.createSelection();this._oSelection.attachEvent("change",this.fireSelectionChange,this);};D.prototype.exit=function(){this._destroyAllOverlays();this._oSelection.destroy();};D.prototype.createSelection=function(){return new S();};D.prototype.getSelection=function(){return this._oSelection.getSelection();};D.prototype.setSelectionMode=function(m){this.setProperty("selectionMode",m);this._oSelection.setMode(m);return this;};D.prototype.getPlugins=function(){return this.getAggregation("plugins")||[];};D.prototype.addPlugin=function(p){p.setDesignTime(this);this.addAggregation("plugins",p);return this;};D.prototype.insertPlugin=function(p,i){p.setDesignTime(this);this.insertAggregation("plugins",p,i);return this;};D.prototype.removePlugin=function(p){this.getPlugins().forEach(function(c){if(c===p){p.setDesignTime(null);return;}});this.removeAggregation("plugins",p);return this;};D.prototype.removeAllPlugins=function(){this.getPlugins().forEach(function(p){p.setDesignTime(null);});this.removeAllAggregation("plugins");return this;};D.prototype.getRootElements=function(){return this.getAssociation("rootElements")||[];};D.prototype.addRootElement=function(r){this.addAssociation("rootElements",r);this._createOverlaysForElement(E.getElementInstance(r));return this;};D.prototype.removeRootElement=function(r){this.removeAssociation("rootElements",r);this._destroyOverlaysForElement(E.getElementInstance(r));return this;};D.prototype.removeAllRootElement=function(){this.removeAssociation("rootElements");this._destroyAllOverlays();return this;};D.prototype.createOverlay=function(e){return new O({element:e});};D.prototype.getOverlays=function(){var o=[];this._iterateAllElements(function(e){var b=a.getOverlay(e);if(b){if(o.indexOf(b)===-1){o.push(b);}}});return o;};D.prototype._createOverlay=function(e){if(!a.getOverlay(e)){var o=this.createOverlay(e);o.attachEvent("elementModified",this._onElementModified,this);o.attachEvent("destroyed",this._onOverlayDestroyed,this);o.attachEvent("selectionChange",this._onOverlaySelectionChange,this);this.fireOverlayCreated({overlay:o});}};D.prototype._createOverlaysForElement=function(r){var t=this;this._iterateRootElementPublicChildren(r,function(e){t._createOverlay(e);});};D.prototype._destroyOverlaysForElement=function(r){this._iterateRootElementPublicChildren(r,function(e){var o=a.getOverlay(e);if(o){o.destroy();}});};D.prototype._destroyAllOverlays=function(){var t=this;this._iterateRootElements(function(r){t._destroyOverlaysForElement(r);});};D.prototype._onOverlayDestroyed=function(e){var o=e.getSource();this._oSelection.remove(o);};D.prototype._onOverlaySelectionChange=function(e){var o=e.getSource();var s=e.getParameter("selected");this._oSelection.set(o,s);};D.prototype._onElementModified=function(e){var p=e.getParameters();if(p.type==="addAggregation"||p.type==="insertAggregation"){this._onOverlayElementAddAggregation(p.value);}else if(p.type==="setParent"){this._onOverlayElementSetParent(p.target,p.value);}};D.prototype._onOverlayElementAddAggregation=function(e){var o=a.getOverlay(e);if(!o){this._createOverlaysForElement(e);}};D.prototype._onOverlayElementSetParent=function(e,p){var o=a.getOverlay(e);if(o&&!this._isElementInRootElements(e)){o.destroy();}};D.prototype._isElementInRootElements=function(e){var f=false;this._iterateRootElements(function(r){if(E.hasAncestor(e,r)){f=true;return false;}});return f;};D.prototype._iterateRootElements=function(s){var r=this.getRootElements();r.forEach(function(R){var o=E.getElementInstance(R);s(o);});};D.prototype._iterateRootElementPublicChildren=function(r,s){var A=E.findAllPublicElements(r);A.forEach(function(e){s(e);});};D.prototype._iterateAllElements=function(s){var t=this;this._iterateRootElements(function(r){t._iterateRootElementPublicChildren(r,s);});};return D;},true);
