/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/core/Control','sap/ui/dt/ControlObserver','sap/ui/dt/ManagedObjectObserver','sap/ui/dt/DesignTimeMetadata','sap/ui/dt/AggregationOverlay','sap/ui/dt/OverlayRegistry','sap/ui/dt/ElementUtil','sap/ui/dt/OverlayUtil','sap/ui/dt/DOMUtil'],function(q,C,a,M,D,A,O,E,b,c){"use strict";var o="overlay-container";var d;var e=C.extend("sap.ui.dt.Overlay",{metadata:{library:"sap.ui.dt",properties:{visible:{type:"boolean",defaultValue:true},selected:{type:"boolean",defaultValue:false},selectable:{type:"boolean",defaultValue:true},draggable:{type:"boolean",defaultValue:false}},associations:{element:{type:"sap.ui.core.Element"}},aggregations:{_aggregationOverlays:{type:"sap.ui.dt.AggregationOverlay",multiple:true,visibility:"hidden"},designTimeMetadata:{type:"sap.ui.dt.DesignTimeMetadata",multiple:false}},events:{destroyed:{parameters:{}},selectionChange:{parameters:{selected:{type:"boolean"}}},draggableChange:{parameters:{selected:{draggable:"boolean"}}},elementModified:{parameters:{type:"string",value:"any",oldValue:"any",target:"sap.ui.core.Element"}}}}});e.getOverlayContainer=function(){if(!d){d=q("#"+o);if(!d.length){d=q("<div id='"+o+"'></div>").appendTo("body");}}return d.get(0);};e.removeOverlayContainer=function(){if(d){d.remove();}d=null;};e.prototype.init=function(){this._oDefaultDesignTimeMetadata=null;this._addToOverlayContainer();this._bVisible=null;};e.prototype.exit=function(){this._destroyDefaultDesignTimeMetadata();var f=this.getElementInstance();if(f){O.deregister(f);this._unobserve(f);}else{O.deregister(this._elementId);}if(!O.hasOverlays()){e.removeOverlayContainer();}delete this._oDomRef;delete this._bVisible;delete this._elementId;this.fireDestroyed();};e.prototype.onAfterRendering=function(){this._oDomRef=this.getDomRef();if(this._oDomRef){this._updateDom();}};e.prototype.getDomRef=function(){return this._oDomRef||C.prototype.getDomRef.apply(this,arguments);};e.prototype.setElement=function(v){var f=this.getElementInstance();if(f instanceof sap.ui.core.Element){O.deregister(f);this._unobserve(f);}this.destroyAggregation("_aggregationOverlays");this._destroyDefaultDesignTimeMetadata();delete this._elementId;this.setAssociation("element",v);this._createAggregationOverlays();var g=this.getElementInstance();this._elementId=g.getId();O.register(g,this);this._observe(g);var p=b.getClosestOverlayFor(g);if(p){p.sync();}return this;};e.prototype.getVisible=function(){if(this._bVisible===null){return this.getDesignTimeMetadata().isVisible();}else{return this.getProperty("visible");}};e.prototype.setVisible=function(v){this.setProperty("visible",v);this._bVisible=v;return this;};e.prototype.setSelectable=function(s){if(!s){this.setSelected(false);}this.setProperty("selectable",s);return this;};e.prototype.setSelected=function(s,S){if(this.isSelectable()&&s!==this.isSelected()){this.setProperty("selected",s);this.toggleStyleClass("sapUiDtOverlaySelected",s);if(!S){this.fireSelectionChange({selected:s});}}return this;};e.prototype.setDraggable=function(f){if(this.getDraggable()!==f){this.toggleStyleClass("sapUiDtOverlayDraggable",f);this.setProperty("draggable",f);this.fireDraggableChange({draggable:f});}return this;};e.prototype.getDesignTimeMetadata=function(){var f=this.getAggregation("designTimeMetadata");if(!f&&!this._oDefaultDesignTimeMetadata){this._oDefaultDesignTimeMetadata=new D({data:this._getElementDesignTimeMetadata()});}return f||this._oDefaultDesignTimeMetadata;};e.prototype.sync=function(){var t=this;var f=this.getAggregationOverlays();f.forEach(function(g){t._syncAggregationOverlay(g);});};e.prototype.applyStyles=function(){var f=this.getGeometry();if(f){var g=b.getClosestScrollable(this)||this.getParent();var p=(g&&g instanceof A)?g.$().offset():null;var s=(g&&g instanceof A)?g.$().scrollLeft():null;var S=(g&&g instanceof A)?g.$().scrollTop():null;var P=c.getOffsetFromParent(f.position,p,S,s);var z=c.getZIndex(f.domRef);var $=this.$();var m=f.size;$.css("width",m.width+"px");$.css("height",m.height+"px");$.css("top",P.top+"px");$.css("left",P.left+"px");if(z){$.css("z-index",z);}this.getAggregationOverlays().forEach(function(h){h.applyStyles();});}};e.prototype.getGeometry=function(){var f=this.getAssociatedDomRef();var g=c.getGeometry(f);if(!g){var h=[];this.getAggregationOverlays().forEach(function(i){h.push(i.getGeometry());});g=b.getGeometry(h);}return g;};e.prototype._updateDom=function(){var f=this.getGeometry();var p=this.getParent();if(p){if(p.getDomRef){this.$().appendTo(p.getDomRef());}else{this.$().appendTo(e.getOverlayContainer());this.applyStyles();}}if(f&&this.isVisible()){this.$().show();}else{this.$().hide();}};e.prototype._createAggregationOverlays=function(){var f=this.getElementInstance();var g=this.getDesignTimeMetadata();if(f){var t=this;E.iterateOverAllPublicAggregations(f,function(h,i){var s=h.name;var j=new A({aggregationName:s,visible:g.isAggregationVisible(s)});t._syncAggregationOverlay(j);t.addAggregation("_aggregationOverlays",j);});}};e.prototype._destroyDefaultDesignTimeMetadata=function(){if(this._oDefaultDesignTimeMetadata){this._oDefaultDesignTimeMetadata.destroy();this._oDefaultDesignTimeMetadata=null;}};e.prototype._getElementDesignTimeMetadata=function(){var f=this.getElementInstance();return f?f.getMetadata().getDesignTime():{};};e.prototype._observe=function(f){if(f instanceof sap.ui.core.Control){this._oObserver=new a({target:f});this._oObserver.attachDomChanged(this._onElementDomChanged,this);}else{this._oObserver=new M({target:f});}this._oObserver.attachModified(this._onElementModified,this);this._oObserver.attachDestroyed(this._onElementDestroyed,this);};e.prototype._unobserve=function(f){this._oObserver.destroy();};e.prototype._addToOverlayContainer=function(){this.placeAt(e.getOverlayContainer());};e.prototype._syncAggregationOverlay=function(f){var s=f.getAggregationName();var g=E.getAggregation(this.getElementInstance(),s);g.forEach(function(h){var i=O.getOverlay(h);if(i){f.addChild(i);}});};e.prototype._onElementModified=function(f){this.sync();this.invalidate();this.fireElementModified(f.getParameters());};e.prototype._onElementDomChanged=function(){this.invalidate();};e.prototype._onElementDestroyed=function(){this.destroy();};e.prototype.getElementInstance=function(){return sap.ui.getCore().byId(this.getElement());};e.prototype.getAssociatedDomRef=function(){return E.getDomRef(this.getElementInstance());};e.prototype.getAggregationOverlays=function(){return this.getAggregation("_aggregationOverlays")||[];};e.prototype.getAggregationOverlay=function(s){var f=this.getAggregation("_aggregationOverlays").filter(function(g){return g.getAggregationName()===s;});if(f.length){return f[0];}};e.prototype.getParentOverlay=function(){var p=this.getParentAggregationOverlay();if(p){return p.getParent();}};e.prototype.getParentAggregationOverlay=function(){var p=this.getParent();return p instanceof sap.ui.dt.AggregationOverlay?p:null;};e.prototype.isSelected=function(){return this.getSelected();};e.prototype.isSelectable=function(){return this.getSelectable();};e.prototype.isDraggable=function(){return this.getDraggable();};e.prototype.isVisible=function(){return this.getVisible();};return e;},true);
