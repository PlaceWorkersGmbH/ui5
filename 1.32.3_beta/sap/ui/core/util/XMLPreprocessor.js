/*!
 * UI development toolkit for HTML5 (OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/BindingParser','sap/ui/base/ManagedObject','sap/ui/core/XMLTemplateProcessor','sap/ui/model/BindingMode','sap/ui/model/CompositeBinding','sap/ui/model/Context'],function(q,B,M,X,a,C,b){'use strict';var u={},N="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1",W=M.extend("sap.ui.core.util._with",{metadata:{properties:{any:"any"},aggregations:{child:{multiple:false,type:"sap.ui.core.util._with"}}}}),R=W.extend("sap.ui.core.util._repeat",{metadata:{aggregations:{list:{multiple:true,type:"n/a",_doesNotRequireFactory:true}}},updateList:function(){}});function c(w,S,i,v){function e(p){if(!v){v=w.getBinding("any");if(v instanceof C){v=v.getBindings();if(i!==undefined){v=v[i];}}}return Array.isArray(v)?v[p]:v;}function f(o){return o instanceof b?o.getPath():o.getModel().resolve(o.getPath(),o.getContext());}return{getInterface:function(p,P){var o,h,m;if(typeof p==="string"){P=p;p=undefined;}e();if(Array.isArray(v)){if(p>=0&&p<v.length){h=v[p];}else{throw new Error("Invalid index of part: "+p);}}else if(p!==undefined){throw new Error("Not the root formatter of a composite binding");}else if(P){h=v;}else{throw new Error("Missing path");}if(P){m=h.getModel();if(P.charAt(0)!=='/'){o=h instanceof b?h:m.createBindingContext(h.getPath(),h.getContext());}h=m.createBindingContext(P,o);if(!h){throw new Error("Model could not create binding context synchronously: "+m);}}return c(null,S,undefined,h);},getModel:function(p){var o=e(p);return o&&o.getModel();},getPath:function(p){var o=e(p);return o&&f(o);},getSetting:function(n){if(n==="bindingContexts"||n==="models"){throw new Error("Illegal argument: "+n);}return S[n];}};}function g(w,o,S){function p(I,i){var f=I.formatter;I.mode=a.OneTime;if(f&&f.requiresIContext===true){I.formatter=f.bind(null,c(w,S,i));}}try{p(o);if(o.parts){o.parts.forEach(p);}w.bindProperty("any",o);return w.getBinding("any")?w.getAny():u;}finally{w.unbindProperty("any",true);}}function d(e,L){return e.namespaceURI===N&&l(e)===L;}function l(n){return n.localName||n.baseName;}function r(e){var m=e.getAttribute("template:require");if(m){q.sap.require.apply(q.sap,m.split(" "));}}function s(e){var A,o=e.attributes,t="<"+e.nodeName,i,n;for(i=0,n=o.length;i<n;i+=1){A=o.item(i);t+=" "+A.name+'="'+A.value+'"';}return t+(e.childNodes.length?">":"/>");}return{process:function(o,v,S){var e=v.caller,D=q.sap.log.isLoggable(q.sap.log.Level.DEBUG),f=D,h=v.name,F={},j=0,k,m={},w=q.sap.log.isLoggable(q.sap.log.Level.WARNING);function p(i){if(D){q.sap.log.debug(z()+Array.prototype.slice.call(arguments,1).join(" "),i&&s(i),"sap.ui.core.util.XMLPreprocessor");}}function t(i){if(D){q.sap.log.debug(z()+"Finished","</"+i.nodeName+">","sap.ui.core.util.XMLPreprocessor");}}function x(i,n){i=i+s(n);q.sap.log.error(i,e,"sap.ui.core.util.XMLPreprocessor");throw new Error(e+": "+i);}function y($){var _=$.childNodes,a1,b1=[],i,n,c1=false;for(i=0,n=_.length;i<n;i+=1){a1=_.item(i);if(a1.nodeType===1){b1.push(a1);}}if(!b1.length||!d(b1[0],"then")){return null;}for(i=1,n=b1.length;i<n;i+=1){a1=b1[i];if(c1){x("Expected </"+$.prefix+":if>, but instead saw ",a1);}if(d(a1,"else")){c1=true;}else if(!d(a1,"elseif")){x("Expected <"+$.prefix+":elseif> or <"+$.prefix+":else>, but instead saw ",b1[i]);}}return b1;}function z(){return(j<10?"[ ":"[")+j+"] ";}function A(k){return k&&k.charAt(0)==="."?q.sap.getObject(k.slice(1),undefined,m):q.sap.getObject(k);}function E(i,n,$,_,a1){var b1=B.complexParser(i,m,_,true,true)||i;if(b1.functionsNotFound){if(_){Z(n,'Function name(s)',b1.functionsNotFound.join(", "),'not found');}return u;}if(typeof b1==="object"){b1=g($,b1,S);if(_&&b1===u){Z(n,'Binding not ready');}}else if(a1){a1();}return b1;}function G(i,n,$){var _,a1=h;$.$mFragmentContexts=$.$mFragmentContexts||{};if($.$mFragmentContexts[i]){x("Cyclic reference to fragment '"+i+"' ",n);}j++;p(n,"fragmentName =",i);$.$mFragmentContexts[i]=true;h=i;_=F[i];if(!_){_=X.loadTemplate(i,"fragment");F[i]=_;}_=_.cloneNode(true);r(_);if(_.namespaceURI==="sap.ui.core"&&l(_)==="FragmentDefinition"){H(_,$,n);}else{n.parentNode.insertBefore(_,n);Y(_,$);}n.parentNode.removeChild(n);h=a1;$.$mFragmentContexts[i]=false;t(n);j--;}function H(i,n,$){var _;$=$||i;V(i,n);while((_=i.firstChild)){$.parentNode.insertBefore(_,$);}}function I(i,n){var $=Z.bind(null,i,'Constant test condition'),_,a1=i.getAttribute("test"),b1;try{b1=E(a1,i,n,true,$);if(b1===u){b1=false;}}catch(ex){Z(i,'Error in formatter:',ex);b1=undefined;}_=!!b1&&b1!=="false";if(D){if(typeof b1==="string"){b1=JSON.stringify(b1);}else if(b1===undefined){b1="undefined";}else if(Array.isArray(b1)){b1="[object Array]";}p(i,"test ==",b1,"-->",_);}return _;}function J(i,n,$){var _=n.value,a1;try{a1=E(_,i,$,false);if(a1===u){p(i,'Binding not ready for attribute',n.name);}else if(a1===undefined){p(i,"Removed attribute",n.name);i.removeAttribute(n.name);}else{if(D&&a1!==n.value){p(i,n.name,"=",a1);}n.value=a1;}}catch(ex){p(i,'Error in formatter:',ex);}}function K(i,n){var k=i.getAttribute("name"),$,_,a1=i.getAttribute("value");if(!k||k.length<=1||k.lastIndexOf(".")!==0){x("Missing proper relative name in ",i);}k=k.slice(1);$=A(a1);if(!$){x("Invalid value in ",i);}_=m[k];m[k]=$;H(i,n);i.parentNode.removeChild(i);m[k]=_;}function L(i,n){var k=i.getAttribute("name"),$=u,_;try{$=E(k,i,n,true);if($!==u&&$!==k){p(i,"name =",$);}}catch(ex){Z(i,'Error in formatter:',ex);}if($!==u&&sap.ui.core.CustomizingConfiguration){_=sap.ui.core.CustomizingConfiguration.getViewExtension(h,$,v.componentId);if(_&&_.className==="sap.ui.core.Fragment"&&_.type==="XML"){G(_.fragmentName,i,n);return true;}}return false;}function O(i,n){var $=i.getAttribute("fragmentName"),_;try{_=E($,i,n,true);}catch(ex){Z(i,'Error in formatter:',ex);return;}if(_!==u){G(_,i,n);}}function P(i,n){var $=y(i),_,a1;j++;if($){a1=i;_=$.shift();do{if(I(a1,n)){break;}a1=_=$.shift();}while(a1&&l(a1)==="elseif");}else if(I(i,n)){_=i;}if(_){H(_,n,i);}i.parentNode.removeChild(i);t(i);j--;}function Q(n,$){var _=n.getAttribute("list")||"",a1=B.complexParser(_,m,false,true,true),b1,c1,d1,e1,f1=n.getAttribute("var");if(f1===""){x("Missing variable name for ",n);}if(!a1){x("Missing binding for ",n);}if(a1.functionsNotFound){Z(n,'Function name(s)',a1.functionsNotFound.join(", "),'not found');}e1=new R();$.setChild(e1);a1.mode=a.OneTime;e1.bindAggregation("list",a1);c1=e1.getBinding("list");e1.unbindAggregation("list",true);d1=a1.model;if(!c1){x("Missing model '"+d1+"' in ",n);}b1=c1.getContexts(a1.startIndex,a1.length);f1=f1||d1;e1.setModel(c1.getModel(),f1);j++;p(n,"Starting");b1.forEach(function(g1,i){var h1=(i===b1.length-1)?n:n.cloneNode(true);e1.setBindingContext(g1,f1);p(n,f1,"=",g1.getPath());H(h1,e1,n);});t(n);j--;n.parentNode.removeChild(n);}function T(i,n){var $,_,a1,b1,c1=i.getAttribute("helper"),d1,e1=i.getAttribute("path"),f1,g1=i.getAttribute("var");if(g1===""){x("Missing variable name for ",i);}a1=new W();n.setChild(a1);$=B.simpleParser("{"+e1+"}");g1=g1||$.model;if(c1||g1){_=n.getModel($.model);if(!_){x("Missing model '"+$.model+"' in ",i);}f1=_.resolve($.path,n.getBindingContext($.model));if(!f1){x("Cannot resolve path for ",i);}if(c1){b1=A(c1);if(typeof b1!=="function"){x("Cannot resolve helper for ",i);}d1=b1(_.createBindingContext(f1));if(d1 instanceof b){_=d1.getModel();f1=d1.getPath();}else if(d1!==undefined){if(typeof d1!=="string"||d1===""){x("Illegal helper result '"+d1+"' in ",i);}f1=d1;}}a1.setModel(_,g1);a1.bindObject({model:g1,path:f1});}else{a1.bindObject(e1);}j++;p(i,g1,"=",f1);if(a1.getBindingContext(g1)===n.getBindingContext(g1)){Z(i,'Set unchanged path:',f1);a1=n;}H(i,a1);i.parentNode.removeChild(i);t(i);j--;}function U(n,$){var i,_=n.attributes;if(_){for(i=_.length-1;i>=0;i-=1){J(n,_.item(i),$);}}}function V($,_){var i,a1=$.childNodes,n=a1.length,b1=new Array(n);for(i=0;i<n;i+=1){b1[i]=a1.item(i);}for(i=0;i<n;i+=1){Y(b1[i],_);}}function Y(n,i){if(n.nodeType!==1){return;}if(n.namespaceURI===N){switch(l(n)){case"alias":K(n,i);return;case"if":P(n,i);return;case"repeat":Q(n,i);return;case"with":T(n,i);return;default:x("Unexpected tag ",n);}}else if(n.namespaceURI==="sap.ui.core"){switch(l(n)){case"ExtensionPoint":if(L(n,i)){return;}break;case"Fragment":if(n.getAttribute("type")==="XML"){O(n,i);return;}break;}}U(n,i);V(n,i);}function Z(i){if(w){if(!f){f=true;q.sap.log.warning("Warning(s) during processing of "+e,null,"sap.ui.core.util.XMLPreprocessor");}q.sap.log.warning(z()+Array.prototype.slice.call(arguments,1).join(" "),i&&s(i),"sap.ui.core.util.XMLPreprocessor");}}S=S||{};if(D){p(undefined,"Start processing",e);if(S.bindingContexts instanceof b){p(undefined,"undefined =",S.bindingContexts);}else{for(k in S.bindingContexts){p(undefined,k,"=",S.bindingContexts[k]);}}}r(o);Y(o,new W({models:S.models,bindingContexts:S.bindingContexts}));p(undefined,"Finished processing",e);return o;}};},true);
