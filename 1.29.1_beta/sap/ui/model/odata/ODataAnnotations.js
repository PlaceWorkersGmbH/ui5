/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','sap/ui/base/EventProvider'],function(q,E){"use strict";var a={EnumMember:true,Path:true,PropertyPath:true,NavigationPropertyPath:true,AnnotationPath:true};var t={Binary:true,Bool:true,Date:true,DateTimeOffset:true,Decimal:true,Duration:true,Float:true,Guid:true,Int:true,String:true,TimeOfDay:true,LabelElementReference:true,EnumMember:true,Path:true,PropertyPath:true,NavigationPropertyPath:true,AnnotationPath:true};var m={And:true,Or:true,Eq:true,Ne:true,Gt:true,Ge:true,Lt:true,Le:true,If:true,Collection:true};var O=sap.ui.base.EventProvider.extend("sap.ui.model.odata.ODataAnnotations",{constructor:function(A,M,p){E.apply(this,arguments);this.oMetadata=M;this.oAnnotations={};this.bLoaded=false;this.bAsync=p&&p.async;this.xPath=null;this.oError=null;this.bValidXML=true;this.oRequestHandles=[];this.oLoadEvent=null;this.oFailedEvent=null;if(A){this.addUrl(A);if(!this.bAsync){if(this.oError){q.sap.log.error("OData annotations could not be loaded: "+this.oError.message);}}}},metadata:{publicMethods:["parse","getAnnotationsData","attachFailed","detachFailed","attachLoaded","detachLoaded"]}});O.prototype.getAnnotationsData=function(){return this.oAnnotations;};O.prototype.isLoaded=function(){return this.bLoaded;};O.prototype.isFailed=function(){return this.oError!==null;};O.prototype.fireLoaded=function(A){this.fireEvent("loaded",A);return this;};O.prototype.attachLoaded=function(d,f,l){this.attachEvent("loaded",d,f,l);return this;};O.prototype.detachLoaded=function(f,l){this.detachEvent("loaded",f,l);return this;};O.prototype.fireFailed=function(A){this.fireEvent("failed",A);return this;};O.prototype.attachFailed=function(d,f,l){this.attachEvent("failed",d,f,l);return this;};O.prototype.detachFailed=function(f,l){this.detachEvent("failed",f,l);return this;};O.prototype._parseReferences=function(x,A,b){var f=false;var n,i;var s="//edmx:Reference/edmx:Include[@Namespace and @Alias]";var o=this.xPath.selectNodes(x,s,x);for(i=0;i<o.length;++i){f=true;n=this.xPath.nextNode(o,i);b[n.getAttribute("Alias")]=n.getAttribute("Namespace");}var r="//edmx:Reference[@Uri]/edmx:IncludeAnnotations[@TermNamespace]";var R=this.xPath.selectNodes(x,r,x);for(i=0;i<R.length;++i){f=true;n=this.xPath.nextNode(R,i);var T=n.getAttribute("TermNamespace");var c=n.getAttribute("TargetNamespace");var d=n.parentNode.getAttribute("Uri");if(c){if(!A[c]){A[c]={};}A[c][T]=d;}else{A[T]=d;}}return f;};O.prototype.parse=function(x){var b={},s,S={},c,d,T,e,f,M,g,h,l,n,o,p,r,u,v,w,y,z,A,B,C,D,F,G,i,H;this.xPath=this.getXPath();this.oServiceMetadata=this.oMetadata.getServiceMetadata();x=this.xPath.setNameSpace(x);s=this.xPath.selectNodes(x,"//d:Schema",x);for(i=0;i<s.length;i+=1){c=this.xPath.nextNode(s,i);S.Alias=c.getAttribute("Alias");S.Namespace=c.getAttribute("Namespace");}var I={};var J={};var K=this._parseReferences(x,I,J);if(K){b.annotationReferences=I;b.aliasDefinitions=J;}d=this.xPath.selectNodes(x,"//d:Term",x);if(d.length>0){T={};for(H=0;H<d.length;H+=1){e=this.xPath.nextNode(d,H);f=this.replaceWithAlias(e.getAttribute("Type"),J);T["@"+S.Alias+"."+e.getAttribute("Name")]=f;}b.termDefinitions=T;}M=this.getAllPropertiesMetadata(this.oServiceMetadata);if(M.extensions){b.propertyExtensions=M.extensions;}g=this.xPath.selectNodes(x,"//d:Annotations ",x);for(H=0;H<g.length;H+=1){h=this.xPath.nextNode(g,H);if(h.hasChildNodes()===false){continue;}l=h.getAttribute("Target");n=l.split(".")[0];if(n&&J[n]){l=l.replace(new RegExp(n,""),J[n]);}o=l;p=null;var L=null;if(l.indexOf("/")>0){o=l.split("/")[0];var N=this.oServiceMetadata.dataServices&&this.oServiceMetadata.dataServices.schema&&this.oServiceMetadata.dataServices.schema.length;if(N){for(var j=this.oServiceMetadata.dataServices.schema.length-1;j>=0;j--){var P=this.oServiceMetadata.dataServices.schema[j];if(P.entityContainer){var Q=o.split('.');for(var k=P.entityContainer.length-1;k>=0;k--){if(P.entityContainer[k].name===Q[Q.length-1]){L=l.replace(o+"/","");break;}}}}}if(!L){p=l.replace(o+"/","");}}if(p){if(!b.propertyAnnotations){b.propertyAnnotations={};}if(!b.propertyAnnotations[o]){b.propertyAnnotations[o]={};}if(!b.propertyAnnotations[o][p]){b.propertyAnnotations[o][p]={};}r=this.xPath.selectNodes(x,"./d:Annotation",h);for(var R=0;R<r.length;R+=1){u=this.xPath.nextNode(r,R);v=this.replaceWithAlias(u.getAttribute("Term"),J);var U=h.getAttribute("Qualifier")||u.getAttribute("Qualifier");if(U){v+="#"+U;}if(u.hasChildNodes()===false){b.propertyAnnotations[o][p][v]=this.getPropertyValueAttributes(u,J);}else{b.propertyAnnotations[o][p][v]=this.getPropertyValue(x,u,J);}}}else{var V;if(L){if(!b["EntityContainer"]){b["EntityContainer"]={};}if(!b["EntityContainer"][o]){b["EntityContainer"][o]={};}V=b["EntityContainer"][o];}else{if(!b[o]){b[o]={};}V=b[o];}w=o.replace(J[n],n);r=this.xPath.selectNodes(x,"./d:Annotation",h);for(var W=0;W<r.length;W+=1){u=this.xPath.nextNode(r,W);y=h.getAttribute("Qualifier")||u.getAttribute("Qualifier");z=this.replaceWithAlias(u.getAttribute("Term"),J);if(y){z+="#"+y;}A=this.getPropertyValue(x,u,J);A=this.setEdmTypes(A,M.types,o,S);if(!L){V[z]=A;}else{if(!V[L]){V[L]={};}V[L][z]=A;}}B=this.xPath.selectNodes(x,"//d:Annotations[contains(@Target, '"+w+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",x);for(i=0;i<B.length;i+=1){C=this.xPath.nextNode(B,i);D=C.value;if(b.propertyAnnotations){if(b.propertyAnnotations[o]){if(b.propertyAnnotations[o][D]){continue;}}}F=D.split('/');if(this.isNavProperty(o,F[0],this.oServiceMetadata)){if(!b.expand){b.expand={};}if(!b.expand[o]){b.expand[o]={};}b.expand[o][F[0]]=F[0];}}G=this.xPath.selectNodes(x,"//d:Annotations[contains(@Target, '"+w+"')]//d:Path[contains(., '/')]",x);for(i=0;i<G.length;i+=1){C=this.xPath.nextNode(G,i);D=this.xPath.getNodeText(C);if(b.propertyAnnotations&&b.propertyAnnotations[o]&&b.propertyAnnotations[o][D]){continue;}if(!b.expand){b.expand={};}if(!b.expand[o]){b.expand[o]={};}F=D.split('/');if(this.isNavProperty(o,F[0],this.oServiceMetadata)){if(!b.expand){b.expand={};}if(!b.expand[o]){b.expand[o]={};}b.expand[o][F[0]]=F[0];}}}}return b;};O.prototype.getXPath=function(){var x={};if(sap.ui.Device.browser.internet_explorer){x={setNameSpace:function(o){o.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');o.setProperty("SelectionLanguage","XPath");return o;},selectNodes:function(o,x,i){return i.selectNodes(x);},nextNode:function(n){return n.nextNode();},getNodeText:function(n){return n.text;}};}else{x={setNameSpace:function(o){return o;},nsResolver:function(p){var n={"edmx":"http://docs.oasis-open.org/odata/ns/edmx","d":"http://docs.oasis-open.org/odata/ns/edm"};return n[p]||null;},selectNodes:function(o,p,i){var b=o.evaluate(p,i,this.nsResolver,7,null);b.length=b.snapshotLength;return b;},nextNode:function(n,i){return n.snapshotItem(i);},getNodeText:function(n){return n.textContent;}};}x.getPath=function(n){var p="";var I="getAttribute"in n?n.getAttribute("id"):"";var T=n.tagName?n.tagName:"";if(I){p='id("'+I+'")';}else if(n===document){p="/";}else if(n===document.body){p=T;}else if(n.parentNode){var P=1;for(var i=0;i<n.parentNode.childNodes.length;++i){if(n.parentNode.childNodes[i]===n){p=x.getPath(n.parentNode)+"/"+T+"["+P+"]";break;}else if(n.parentNode.childNodes[i].nodeType===1&&n.parentNode.childNodes[i].tagName===T){++P;}}}else{q.sap.log.error("Wrong Input node - cannot find XPath to it: "+T);}return p;};return x;};O.prototype.setXML=function(x,X,o){var d={success:function(){},error:function(){},fireEvents:false};o=q.extend({},d,o);var b=null;if(sap.ui.Device.browser.internet_explorer){b=new ActiveXObject("Microsoft.XMLDOM");b.preserveWhiteSpace=true;b.loadXML(X);}else if(x){b=x;}else if(window.DOMParser){b=new DOMParser().parseFromString(X,'application/xml');}else{q.sap.log.fatal("The browser does not support XML parsing. Annotations are not available.");return;}var p=function(b){var r={xmlDoc:b};var A=this.parse(b);if(A){if(!this.oAnnotations){this.oAnnotations={};}q.extend(true,this.oAnnotations,A);r.annotations=this.oAnnotations;this.bLoaded=true;o.success(r);if(o.fireEvents){this.fireLoaded(r);}}else{o.error(r);if(o.fireEvents){this.fireFailed(r);}}}.bind(this,b);if(b.getElementsByTagName("parsererror").length>0||(b.parseError&&b.parseError.errorCode!==0)){o.error({xmlDoc:b});return false;}else{var M=this.oMetadata.getServiceMetadata();if(!M||q.isEmptyObject(M)){this.oMetadata.attachLoaded(p);}else{p();}return true;}};O.prototype.addUrl=function(u){var b=this;var U=u;if(Array.isArray(u)&&u.length==0){return Promise.resolve({annotations:this.oAnnotations});}if(!Array.isArray(u)){U=[u];}return new Promise(function(r,R){var l=0;var c={annotations:null,success:[],fail:[]};var f=function(d){l++;if(d.type==="success"){c.success.push(d);}else{c.fail.push(d);}if(l===U.length){c.annotations=b.oAnnotations;if(c.success.length>0){var s={annotations:b.oAnnotations,results:c};if(b.bAsync){b.fireLoaded(s);}else{b.oLoadEvent=q.sap.delayedCall(0,b,b.fireLoaded,[s]);}}if(c.success.length<U.length){R(c);}else{r(c);}}};for(var i=0;i<U.length;++i){b._loadFromUrl(U[i]).then(f,f);}});};O.prototype._loadFromUrl=function(u){var b=this;return new Promise(function(r,R){var A={url:u,async:b.bAsync};var o;var f=function(j,S){if(o&&o.bSuppressErrorHandlerCall){return;}b.oError={type:"fail",url:u,message:S,statusCode:j.statusCode,statusText:j.statusText,responseText:j.responseText};if(b.bAsync){b.oFailedEvent=q.sap.delayedCall(0,b,b.fireFailed,[b.oError]);}else{b.fireFailed(b.oError);}R(b.oError);};var s=function(d,S,j){b.setXML(j.responseXML,j.responseText,{success:function(D){r({type:"success",url:u,message:S,statusCode:j.statusCode,statusText:j.statusText,responseText:j.responseText});},error:function(D){f(j,"Malformed XML document");}});};q.ajax(A).done(s).fail(f);});};O.prototype.getAllPropertiesMetadata=function(M){var o={},P={},b={},c=false,n,e,C,d={},f={},g={},h=false,r,s,u,T,v,R={types:P};if(!M.dataServices.schema){return R;}for(var i=M.dataServices.schema.length-1;i>=0;i-=1){o=M.dataServices.schema[i];if(o.entityType){n=o.namespace;e=o.entityType;C=o.complexType;for(var j in e){d=e[j];g={};f={};if(d.hasStream&&d.hasStream==="true"){continue;}for(var k in d.property){r=d.property[k];if(r.type.substring(0,n.length)===n){for(var l in C){if(C[l].name===r.type.substring(n.length+1)){for(k in C[l].property){s=C[l].property[k];f[C[l].name+"/"+s.name]=s.type;}}}}else{u=r.name;T=r.type;for(var p in r.extensions){v=r.extensions[p];if((v.name==="display-format")&&(v.value==="Date")){T="Edm.Date";}else{h=true;if(!g[u]){g[u]={};}if(v.namespace&&!g[u][v.namespace]){g[u][v.namespace]={};}g[u][v.namespace][v.name]=v.value;}}f[u]=T;}}if(!P[n+"."+d.name]){P[n+"."+d.name]={};}P[n+"."+d.name]=f;if(h){if(!b[n+"."+d.name]){c=true;}b[n+"."+d.name]={};b[n+"."+d.name]=g;}}}}if(c){R={types:P,extensions:b};}return R;};O.prototype.setEdmTypes=function(p,P,T,s){var o,e='';for(var b in p){if(p[b]){o=p[b];if(o.Value&&o.Value.Path){e=this.getEdmType(o.Value.Path,P,T,s);if(e){p[b].EdmType=e;}continue;}if(o.Path){e=this.getEdmType(o.Path,P,T,s);if(e){p[b].EdmType=e;}continue;}if(o.Facets){p[b].Facets=this.setEdmTypes(o.Facets,P,T,s);continue;}if(o.Data){p[b].Data=this.setEdmTypes(o.Data,P,T,s);continue;}if(b==="Data"){p.Data=this.setEdmTypes(o,P,T,s);continue;}if(o.Value&&o.Value.Apply){p[b].Value.Apply.Parameters=this.setEdmTypes(o.Value.Apply.Parameters,P,T,s);continue;}if(o.Value&&o.Type&&(o.Type==="Path")){e=this.getEdmType(o.Value,P,T,s);if(e){p[b].EdmType=e;}}}}return p;};O.prototype.getEdmType=function(p,P,T,s){if((p.charAt(0)==="@")&&(p.indexOf(s.Alias)===1)){p=p.slice(s.Alias.length+2);}if(p.indexOf("/")>=0){if(P[p.slice(0,p.indexOf("/"))]){T=p.slice(0,p.indexOf("/"));p=p.slice(p.indexOf("/")+1);}}for(var b in P[T]){if(p===b){return P[T][b];}}};O.prototype.getPropertyValueAttributes=function(n,A){var I={"Property":true,"Term":true,"Qualifier":true};var b={};for(var i=0;i<n.attributes.length;i+=1){if(!I[n.attributes[i].name]){b[n.attributes[i].name]=this.replaceWithAlias(n.attributes[i].value,A);}}return b;};O.prototype._getRecordValues=function(x,A,n){var N=[];for(var i=0;i<n.length;++i){var o=this.xPath.nextNode(n,i);var v=this.getPropertyValues(x,o,A);var T=o.getAttribute("Type");if(T){v["RecordType"]=this.replaceWithAlias(T,A);}N.push(v);}return N;};O.prototype._getTextValues=function(x,n,A){var N=[];for(var i=0;i<n.length;i+=1){var o=this.xPath.nextNode(n,i);var v={};var T=this.xPath.getNodeText(o);v[o.nodeName]=A?this.replaceWithAlias(T,A):T;N.push(v);}return N;};O.prototype._getTextValue=function(n,A){var v="";if(n.nodeName in a){v=this.replaceWithAlias(this.xPath.getNodeText(n),A);}else{v=this.xPath.getNodeText(n);}if(n.nodeName!=="String"){v=v.trim();}return v;};O.prototype.getPropertyValue=function(x,d,A){var p={};if(d.hasChildNodes()){var r=this.xPath.selectNodes(x,"./d:Record",d);var R=this._getRecordValues(x,A,r);var c=this.xPath.selectNodes(x,"./d:Collection/d:Record | ./d:Collection/d:If/d:Record",d);var C=this._getRecordValues(x,A,c);var P=R.concat(C);if(P.length>0){if(c.length===0&&r.length>0){p=P[0];}else{p=P;}}else{var o=this.xPath.selectNodes(x,"./d:Collection/d:AnnotationPath | ./d:Collection/d:PropertyPath",d);if(o.length>0){p=this._getTextValues(x,o,A);}else{p=this.getPropertyValueAttributes(d,A);var b=this.xPath.selectNodes(x,"./d:*[not(local-name() = \"Annotation\")]",d);if(b.length>0){for(var i=0;i<b.length;i++){var e=this.xPath.nextNode(b,i);var v;var n=e.nodeName;var s=e.parentNode.nodeName;if(n==="Apply"){v=this.getApplyFunctions(x,e,A);}else{v=this.getPropertyValue(x,e,A);}if(m[s]){if(!Array.isArray(p)){p=[];}var V={};V[n]=v;p.push(V);}else{if(p[n]){q.sap.log.warning("Annotation contained multiple "+n+" values. Only the last "+"one will be stored: "+this.xPath.getPath(e));}p[n]=v;}}}else if(d.nodeName in t){p=this._getTextValue(d,A);}}}}else if(d.nodeName in t){p=this._getTextValue(d,A);}else{p=this.getPropertyValueAttributes(d,A);}return p;};O.prototype.getPropertyValues=function(x,d,A){var p={},b={},c,n,e,f,g,h,i,j,k,l;c=this.xPath.selectNodes(x,"./d:Annotation",d);for(n=0;n<c.length;n+=1){b=this.xPath.nextNode(c,n);if(b.hasChildNodes()===false){e=this.replaceWithAlias(b.getAttribute("Term"),A);p[e]=this.getPropertyValueAttributes(b,A);}}f=this.xPath.selectNodes(x,"./d:PropertyValue",d);if(f.length>0){for(g=0;g<f.length;g+=1){h=this.xPath.nextNode(f,g);i=h.getAttribute("Property");p[i]=this.getPropertyValue(x,h,A);j=this.xPath.selectNodes(x,"./d:Apply",h);k=null;for(l=0;l<j.length;l+=1){k=this.xPath.nextNode(j,l);if(k){p[i]={};p[i]['Apply']=this.getApplyFunctions(x,k,A);}}}}else{p=this.getPropertyValue(x,d,A);}return p;};O.prototype.getApplyFunctions=function(x,b,A){var c={Name:b.getAttribute('Function'),Parameters:[]};var p=this.xPath.selectNodes(x,"./d:*",b);for(var i=0;i<p.length;i+=1){var P=this.xPath.nextNode(p,i);var d={Type:P.nodeName};if(P.nodeName==="Apply"){d.Value=this.getApplyFunctions(x,P);}else if(P.nodeName==="LabeledElement"){d.Value=this.getPropertyValue(x,P,A);d.Name=d.Value.Name;delete d.Value.Name;}else if(m[P.nodeName]){d.Value=this.getPropertyValue(x,P,A);}else{d.Value=this.xPath.getNodeText(P);}c.Parameters.push(d);}return c;};O.prototype.isNavProperty=function(e,p,M){for(var i=M.dataServices.schema.length-1;i>=0;i-=1){var o=M.dataServices.schema[i];if(o.entityType){var n=o.namespace+".";var b=o.entityType;for(var k=b.length-1;k>=0;k-=1){if(n+b[k].name===e&&b[k].navigationProperty){for(var j=0;j<b[k].navigationProperty.length;j+=1){if(b[k].navigationProperty[j].name===p){return true;}}}}}}return false;};O.prototype.replaceWithAlias=function(v,A,r){if(r===undefined){r=1;}for(var s in A){if(v.indexOf(s+".")>=0&&v.indexOf("."+s+".")<0){v=v.replace(s+".",A[s]+".");r--;if(r===0){return v;}}}return v;};O.prototype.destroy=function(){for(var i=0;i<this.oRequestHandles.length;++i){if(this.oRequestHandles[i]){this.oRequestHandles[i].bSuppressErrorHandlerCall=true;this.oRequestHandles[i].abort();this.oRequestHandles[i]=null;}}sap.ui.base.Object.prototype.destroy.apply(this,arguments);if(this.oLoadEvent){q.sap.clearDelayedCall(this.oLoadEvent);}if(this.oFailedEvent){q.sap.clearDelayedCall(this.oFailedEvent);}};return O;},true);
