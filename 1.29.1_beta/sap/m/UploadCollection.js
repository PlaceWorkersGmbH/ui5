/*!
 * SAP UI development toolkit for HTML5 (SAPUI5/OpenUI5)
 * (c) Copyright 2009-2015 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['jquery.sap.global','./MessageBox','./MessageToast','./library','sap/ui/core/Control','sap/ui/unified/library','sap/ui/core/format/FileSizeFormat','sap/m/ObjectAttribute'],function(q,M,a,l,C,b,F,O){"use strict";var U=C.extend("sap.m.UploadCollection",{constructor:function(i,s){var I;if(s&&s.instantUpload===false){I=s.instantUpload;delete s.instantUpload;}else if(i&&i.instantUpload===false){I=i.instantUpload;delete i.instantUpload;}try{C.apply(this,arguments);if(I===false){this.setProperty("instantUpload",I,true);this._oFormatDecimal=F.getInstance({binaryFilesize:false,maxFractionDigits:1,maxIntegerDigits:3});}}catch(e){this.destroy();throw e;}},metadata:{library:"sap.m",properties:{fileType:{type:"string[]",group:"Data",defaultValue:null},maximumFilenameLength:{type:"int",group:"Data",defaultValue:null},maximumFileSize:{type:"float",group:"Data",defaultValue:null},mimeType:{type:"string[]",group:"Data",defaultValue:null},multiple:{type:"boolean",group:"Behavior",defaultValue:false},noDataText:{type:"string",group:"Behavior",defaultValue:null},sameFilenameAllowed:{type:"boolean",group:"Behavior",defaultValue:false},showSeparators:{type:"sap.m.ListSeparators",group:"Appearance",defaultValue:sap.m.ListSeparators.All},uploadEnabled:{type:"boolean",group:"Behavior",defaultValue:true},uploadUrl:{type:"string",group:"Data",defaultValue:"../../../upload"},instantUpload:{type:"boolean",group:"Behavior",defaultValue:true}},defaultAggregation:"items",aggregations:{items:{type:"sap.m.UploadCollectionItem",multiple:true,singularName:"item"},headerParameters:{type:"sap.m.UploadCollectionParameter",multiple:true,singularName:"headerParameter"},parameters:{type:"sap.m.UploadCollectionParameter",multiple:true,singularName:"parameter"}},events:{change:{parameters:{documentId:{type:"string"},files:{type:"object[]"}}},fileDeleted:{parameters:{documentId:{type:"string"},item:{type:"sap.m.UploadCollectionItem"}}},filenameLengthExceed:{parameters:{documentId:{type:"string"},files:{type:"object[]"}}},fileRenamed:{parameters:{documentId:{type:"string"},fileName:{type:"string"},item:{type:"sap.m.UploadCollectionItem"}}},fileSizeExceed:{parameters:{documentId:{type:"string"},fileSize:{type:"string"},files:{type:"object[]"}}},typeMissmatch:{parameters:{documentId:{type:"string"},fileType:{type:"string"},mimeType:{type:"string"},files:{type:"object[]"}}},uploadComplete:{parameters:{readyStateXHR:{type:"string"},response:{type:"string"},status:{type:"string"},files:{type:"object[]"}}},uploadTerminated:{}}}});U._uploadingStatus="uploading";U._displayStatus="display";U._toBeDeletedStatus="toBeDeleted";U.prototype._requestIdName="requestId";U.prototype._requestIdValue=0;U._placeholderCamera='sap-icon://camera';U._pendingUploadStatus="pendingUploadStatus";U.prototype._iFUCounter=0;U.prototype.init=function(){sap.ui.getCore().loadLibrary("sap.ui.layout");U.prototype._oRb=sap.ui.getCore().getLibraryResourceBundle("sap.m");this._oList=new sap.m.List(this.getId()+"-list",{});this._oList.addStyleClass("sapMUCList");this._cAddItems=0;this.aItems=[];this._RenderManager=sap.ui.getCore().createRenderManager();this._aFileUploadersForPendingUpload=[];};U.prototype.setFileType=function(f){if(!f){return this;}if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change fileType at runtime.");}else{var c=f.length;for(var i=0;i<c;i++){f[i]=f[i].toLowerCase();}this.setProperty("fileType",f);if(this._getFileUploader().getFileType()!==f){this._getFileUploader().setFileType(f);}}return this;};U.prototype.setMaximumFilenameLength=function(m){if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change maximumFilenameLength at runtime.");}else{this.setProperty("maximumFilenameLength",m,true);if(this._getFileUploader().getMaximumFilenameLength()!==m){this._getFileUploader().setMaximumFilenameLength(m);}}return this;};U.prototype.setMaximumFileSize=function(m){if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change maximumFileSize at runtime.");}else{this.setProperty("maximumFileSize",m,true);if(this._getFileUploader().getMaximumFileSize()!==m){this._getFileUploader().setMaximumFileSize(m);}}return this;};U.prototype.setMimeType=function(m){if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change mimeType at runtime.");}else{this.setProperty("mimeType",m);if(this._getFileUploader().getMimeType()!==m){this._getFileUploader().setMimeType(m);}return this;}};U.prototype.setMultiple=function(m){if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change multiple at runtime.");}else{this.setProperty("multiple",m);if(this._getFileUploader().getMultiple()!==m){this._getFileUploader().setMultiple(m);}return this;}};U.prototype.setNoDataText=function(n){this.setProperty("noDataText",n);if(this._oList.getNoDataText()!==n){this._oList.setNoDataText(n);}return this;};U.prototype.setShowSeparators=function(s){this.setProperty("showSeparators",s);if(this._oList.getShowSeparators()!==s){this._oList.setShowSeparators(s);}return this;};U.prototype.setUploadEnabled=function(u){if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change uploadEnabled at runtime.");}else{this.setProperty("uploadEnabled",u);if(this._getFileUploader().getEnabled()!==u){this._getFileUploader().setEnabled(u);}}return this;};U.prototype.setUploadUrl=function(u){if(!this.getInstantUpload()){q.sap.log.info("As property instantUpload is false it is not allowed to change uploadUrl at runtime.");}else{this.setProperty("uploadUrl",u);if(this._getFileUploader().getUploadUrl()!==u){this._getFileUploader().setUploadUrl(u);}}return this;};U.prototype.setInstantUpload=function(i){q.sap.log.error("It is not supported to change the behavior at runtime.");return this;};U.prototype.upload=function(){if(this.getInstantUpload()){q.sap.log.error("Not a valid API call. 'instantUpload' should be set to 'false'.");}var f=this._aFileUploadersForPendingUpload.length;for(var i=0;i<f;i++){this._aFileUploadersForPendingUpload[i].upload();}};U.prototype.onBeforeRendering=function(){var n=n||{};var N=N||this.getNoDataText();var i,I,c;if(!this.getInstantUpload()){this._getListHeader(this.aItems.length);this._clearList();this._fillList(this.aItems);this._oList.setHeaderToolbar(this.oHeaderToolbar);return;}if(this.aItems.length>0){c=this.aItems.length;var u=[];for(i=0;i<c;i++){if(this.aItems[i]._status===U._uploadingStatus&&this.aItems[i]._percentUploaded!==100){u.push(this.aItems[i]);}else if(this.aItems[i]._status!==U._uploadingStatus&&this.aItems[i]._percentUploaded===100&&this.getItems().length===0){u.push(this.aItems[i]);}else if(this.aItems[i]._status===U._toBeDeletedStatus&&this.getItems().length===0){I=true;this.aItems.splice(i,1);}}if(u.length===0&&!I){this.aItems=this.getItems();}}else{this.aItems=this.getItems();}this._getListHeader(this.aItems.length);this._clearList();this._fillList(this.aItems);this._oList.setAggregation("headerToolbar",this.oHeaderToolbar,true);if((sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9)&&this.aItems.length>0&&this.aItems[0]._status===U._uploadingStatus){this._oFileUploader.setEnabled(false);}else{if(this.sErrorState!=="Error"){if(this.getUploadEnabled()!==this._oFileUploader.getEnabled()){this._oFileUploader.setEnabled(this.getUploadEnabled());}}else{this._oFileUploader.setEnabled(false);}}};U.prototype.onAfterRendering=function(){var t=this,T,i;if(!this.getInstantUpload()){T=this.oHeaderToolbar.getContent().length;if(this._aFileUploadersForPendingUpload.length){for(i=2;i<T-1;i++){this.oHeaderToolbar.getContent()[i].$().hide();}}return;}for(var i=0;i<this._oList.aDelegates.length;i++){if(this._oList.aDelegates[i]._sId&&this._oList.aDelegates[i]._sId==="UploadCollection"){this._oList.aDelegates.splice(i,1);}}if(this.aItems||(this.aItems===this.getItems())){if(this.editModeItem){var $=q.sap.byId(this.editModeItem+"-ta_editFileName-inner");if($){var I=this.editModeItem;if(!sap.ui.Device.os.ios){$.focus(function(){$.selectText(0,$.val().length);});}$.focus();this._oList.addDelegate({onclick:function(e){sap.m.UploadCollection.prototype._handleClick(e,t,I);}});this._oList.aDelegates[this._oList.aDelegates.length-1]._sId="UploadCollection";}}else{if(this.sFocusId){sap.m.UploadCollection.prototype._setFocus2LineItem(this.sFocusId);this.sFocusId=null;}else if(this.sDeletedItemId){sap.m.UploadCollection.prototype._setFocusAfterDeletion(this.sDeletedItemId,t);this.sDeletedItemId=null;}}}};U.prototype.exit=function(){var i,p;if(this._oList){this._oList.destroy();this._oList=null;}if(this.oFileName){this.oFileName.destroy();this.oFileName=null;}if(this._RenderManager){this._RenderManager.destroy();}if(this._aFileUploadersForPendingUpload){p=this._aFileUploadersForPendingUpload.length;for(i=0;i<p;i++){this._aFileUploadersForPendingUpload[i].destroy();this._aFileUploadersForPendingUpload[i]=null;}this._aFileUploadersForPendingUpload=null;}};U.prototype._getListHeader=function(I){var f,n,t,i;var n=this._getNumberOfAttachmentsLabel(I);if(!this.oHeaderToolbar){if(!!this._oFileUploader&&!this.getInstantUpload()){this._oFileUploader.destroy();}f=this._getFileUploader();this.oHeaderToolbar=new sap.m.Toolbar(this.getId()+"-toolbar",{content:[n,new sap.m.ToolbarSpacer(),f]});this.oHeaderToolbar.addStyleClass("sapMUCListHeader");}else{if(!this.getInstantUpload()){var p=this._aFileUploadersForPendingUpload.length;for(i=p-1;i>=0;i--){if(this._aFileUploadersForPendingUpload[i].getId()==this._oFileUploader.getId()){f=this._getFileUploader();t=this.oHeaderToolbar.getContent().length;this.oHeaderToolbar.insertAggregation("content",f,t,true);break;}}}}};U.prototype._mapItemToListItem=function(i){if(!i){return null;}var I,s,f,B,L,c,$,o,d,t=this;I=i.getId();s=i._status;f=i.getFileName();if(s===U._uploadingStatus){B=new sap.m.BusyIndicator(I+"-ia_indicator",{visible:true}).addStyleClass("sapMUCloadingIcon");}d=this._createIcon(i,I,f,t);c=I+"-container";$=q.sap.byId(c);if(!!$){$.remove();$=null;}o=new sap.ui.core.HTML({content:"<span id="+c+" class= sapMUCTextButtonContainer> </span>",afterRendering:function(e){t._renderContent(i,c,t);}});L=new sap.m.CustomListItem(I+"-cli",{content:[B,d,o]});L._status=s;L.addStyleClass("sapMUCItem");return L;};U.prototype._renderContent=function(I,c,t){var s,i,A,S,p,d,e,r,f;p=I._percentUploaded;d=I.getAllAttributes();e=I.getStatuses();s=I.getId();A=d.length;S=e.length;f=I._status;r=t._RenderManager;t._RenderManager=r;r.write('<div class="sapMUCTextContainer ');if(f==="Edit"){r.write('sapMUCEditMode ');}r.write('" >');r.renderControl(this._getFileNameControl(I,t));if(f===U._uploadingStatus&&!(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9)){r.renderControl(this._createProgressLabel(s,p));}else{if(A>0){r.write('<div class="sapMUCAttrContainer">');for(i=0;i<A;i++){d[i].addStyleClass("sapMUCAttr");r.renderControl(d[i]);if((i+1)<A){r.write('<span class="sapMUCSeparator">&nbsp&#x00B7&#160</span>');}}r.write('</div>');}if(S>0){r.write('<div class="sapMUCStatusContainer">');for(i=0;i<S;i++){e[i].detachBrowserEvent("hover");r.renderControl(e[i]);if((i+1)<S){r.write("<span>&nbsp&#x00B7&#160</span>");}}r.write('</div>');}}r.write('</div>');this._renderButtons(r,I,f,s,t);r.flush(q.sap.byId(c)[0],true);};U.prototype._renderButtons=function(r,I,s,c,t){var B,d;B=this._getButtons(I,s,c,t);if(!!B){d=B.length;}if(d>0){r.write('<div class="sapMUCButtonContainer">');for(var i=0;i<d;i++){if((i+1)<d){B[i].addStyleClass("sapMUCFirstButton");}r.renderControl(B[i]);}r.write('</div>');}};U.prototype._getFileNameControl=function(i,t){var e,f,o,s,c,I,S,m,v,d,g,V;c=i.getFileName();I=i.getId();S=i._status;if(S!=="Edit"){e=true;if(this.sErrorState==="Error"||!q.trim(i.getUrl())){e=false;}f=sap.ui.getCore().byId(I+"-ta_filenameHL");if(!f){f=new sap.m.Link(I+"-ta_filenameHL",{text:c,enabled:e,press:function(E){sap.m.UploadCollection.prototype._triggerLink(E,t);}}).addStyleClass("sapMUCFileName");}else{f.setText(c);f.setEnabled(e);}return f;}else{o=t._splitFilename(c);m=t.getMaximumFilenameLength();v="None";d=false;s=o.name;if(i.errorState==="Error"){d=true;v="Error";s=i.changedFileName;if(s.length===0){V=this._oRb.getText("UPLOADCOLLECTION_TYPE_FILENAME");}else{V=this._oRb.getText("UPLOADCOLLECTION_EXISTS");}}g=sap.ui.getCore().byId(I+"-ta_editFileName");if(!g){g=new sap.m.Input(I+"-ta_editFileName",{type:sap.m.InputType.Text,fieldWidth:"60%",valueState:v,valueStateText:V,showValueStateMessage:d,value:s,description:o.extension}).addStyleClass("sapMUCEditBox");}else{g.setValueState(v);g.setFieldWidth("60%");g.setValueStateText(V);g.setValue(s);g.setDescription(o.extension);g.setShowValueStateMessage(d);}if((m-o.extension.length)>0){g.setProperty("maxLength",m-o.extension.length,true);}return g;}};U.prototype._createProgressLabel=function(i,p){var P;P=sap.ui.getCore().byId(i+"-ta_progress");if(!P){P=new sap.m.Label(i+"-ta_progress",{text:this._oRb.getText("UPLOADCOLLECTION_UPLOADING",[p])}).addStyleClass("sapMUCProgress");}else{P.setText(this._oRb.getText("UPLOADCOLLECTION_UPLOADING",[p]));}return P;};U.prototype._createIcon=function(i,I,f,t){var d,T,s,o;d=false;if(this.sErrorState==="Error"||!q.trim(i.getProperty("url"))){d=true;}T=i.getThumbnailUrl();if(T){o=new sap.m.Image(I+"-ia_imageHL",{src:sap.m.UploadCollection.prototype._getThumbnail(T,f),decorative:d}).addStyleClass("sapMUCItemImage");}else{s=sap.m.UploadCollection.prototype._getThumbnail(undefined,f);o=new sap.ui.core.Icon(I+"-ia_iconHL",{src:s,decorative:d}).addStyleClass("sapMUCItemIcon");if(s==U._placeholderCamera){o.addStyleClass("sapMUCItemPlaceholder");}}if(d===false){o.attachPress(function(e){sap.m.UploadCollection.prototype._triggerLink(e,t);});}return o;};U.prototype._getButtons=function(i,s,I,t){var B,o,c,d,D,e,E;B=[];if(!this.getInstantUpload()){d="deleteButton";D=this._createDeleteButton(I,d,i,this.sErrorState,t);B.push(D);return B;}if(s==="Edit"){o=sap.ui.getCore().byId(I+"-okButton");if(!o){o=new sap.m.Button({id:I+"-okButton",text:this._oRb.getText("UPLOADCOLLECTION_OKBUTTON_TEXT"),type:sap.m.ButtonType.Transparent}).addStyleClass("sapMUCOkBtn");}c=sap.ui.getCore().byId(I+"-cancelButton");if(!c){c=new sap.m.Button({id:I+"-cancelButton",text:this._oRb.getText("UPLOADCOLLECTION_CANCELBUTTON_TEXT"),type:sap.m.ButtonType.Transparent}).addStyleClass("sapMUCCancelBtn");}B.push(o);B.push(c);return B;}else if(s===U._uploadingStatus&&!(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9)){d="terminateButton";D=this._createDeleteButton(I,d,i,this.sErrorState,t);B.push(D);return B;}else{e=i.getEnableEdit();if(this.sErrorState==="Error"){e=false;}E=sap.ui.getCore().byId(I+"-editButton");if(!E){if(i.getVisibleEdit()){E=new sap.m.Button({id:I+"-editButton",icon:"sap-icon://edit",type:sap.m.ButtonType.Standard,enabled:e,visible:i.getVisibleEdit(),press:[i,this._handleEdit,this]}).addStyleClass("sapMUCEditBtn");B.push(E);}}else{if(!i.getVisibleEdit()){E.destroy();E=null;}else{E.setEnabled(e);E.setVisible(i.getVisibleEdit());B.push(E);}}d="deleteButton";if(i.getVisibleDelete()){D=this._createDeleteButton(I,d,i,this.sErrorState,t);B.push(D);}else{D=sap.ui.getCore().byId(I+"-"+d);if(!!D){D.destroy();D=null;}}return B;}};U.prototype._createDeleteButton=function(i,B,I,e,t){var E,d;E=I.getEnableDelete();if(e==="Error"){E=false;}d=sap.ui.getCore().byId(i+"-"+B);if(!d){d=new sap.m.Button({id:i+"-"+B,icon:"sap-icon://sys-cancel",type:sap.m.ButtonType.Standard,enabled:E,visible:I.getVisibleDelete()}).addStyleClass("sapMUCDeleteBtn");if(B=="deleteButton"){d.attachPress(function(o){sap.m.UploadCollection.prototype._handleDelete(o,t);});}else if(B=="terminateButton"){d.attachPress(function(o){sap.m.UploadCollection.prototype._handleTerminate(o,t);});}}else{d.setEnabled(E);d.setVisible(I.getVisibleDelete());}return d;};U.prototype._fillList=function(i){var t=this;var m=i.length-1;q.each(i,function(I,o){if(!o._status){o._status=U._displayStatus;}if(!o._percentUploaded&&o._status===U._uploadingStatus){o._percentUploaded=0;}var L=t._mapItemToListItem(o);if(I===0&&m===0){L.addStyleClass("sapMUCListSingleItem");}else if(I===0){L.addStyleClass("sapMUCListFirstItem");}else if(I===m){L.addStyleClass("sapMUCListLastItem");}else{L.addStyleClass("sapMUCListItem");}t._oList.addAggregation("items",L,true);});};U.prototype._clearList=function(){if(this._oList){this._oList.destroyAggregation("items",true);}};U.prototype._getNumberOfAttachmentsLabel=function(i){var n=i||0;if(!this.oNumberOfAttachmentsLabel){this.oNumberOfAttachmentsLabel=new sap.m.Label(this.getId()+"-numberOfAttachmentsLabel",{design:sap.m.LabelDesign.Standard,text:this._oRb.getText("UPLOADCOLLECTION_ATTACHMENTS",[n])});}else{this.oNumberOfAttachmentsLabel.setText(this._oRb.getText("UPLOADCOLLECTION_ATTACHMENTS",[n]));}return this.oNumberOfAttachmentsLabel;};U.prototype._handleDelete=function(e,c){var p=e.getParameters();var I=c.getAggregation("items");var s=p.id.split("-deleteButton")[0];var d=null;var f="";var g;var m;c.sDeletedItemId=s;for(var i=0;i<I.length;i++){if(I[i].sId===s){d=i;break;}}if(q.sap.byId(c.sId).hasClass("sapUiSizeCompact")){f="sapUiSizeCompact";}if(c.editModeItem){sap.m.UploadCollection.prototype._handleOk(e,c,c.editModeItem,true);if(c.sErrorState==="Error"){return this;}}if(!!I[d]){g=I[d].getFileName();if(!g){m=this._oRb.getText("UPLOADCOLLECTION_DELETE_WITHOUT_FILENAME_TEXT");}else{m=this._oRb.getText("UPLOADCOLLECTION_DELETE_TEXT",g);}c._oItemForDelete=I[d];c._oItemForDelete._iLineNumber=d;sap.m.MessageBox.show(m,{title:this._oRb.getText("UPLOADCOLLECTION_DELETE_TITLE"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],onClose:c._onCloseMessageBoxDeleteItem.bind(c),dialogId:"messageBoxDeleteFile",styleClass:f});}};U.prototype._onCloseMessageBoxDeleteItem=function(A){this._oItemForDelete._status=U._toBeDeletedStatus;var c,i=0;if(A===sap.m.MessageBox.Action.OK){if(this.getInstantUpload()){this.fireFileDeleted({documentId:this._oItemForDelete.getDocumentId(),item:this._oItemForDelete});}else{this.aItems.splice(this._oItemForDelete._iLineNumber,1);c=this._aFileUploadersForPendingUpload.length;var s=this._oItemForDelete.getAssociation("fileUploader");for(i=0;i<c;i++){if(s===this._aFileUploadersForPendingUpload[i].getId()){this._aFileUploadersForPendingUpload[i].destroy();this._aFileUploadersForPendingUpload[i]=null;this._aFileUploadersForPendingUpload.splice(i,1);break;}}this.removeAggregation("items",this._oItemForDelete,false);}}};U.prototype._handleTerminate=function(e,c){var s="",u,f,L,d,i,j,g;if(q.sap.byId(c.sId).hasClass("sapUiSizeCompact")){s="sapUiSizeCompact";}u=this._splitString2Array(c._getFileUploader().getProperty("value"),c);for(i=0;i<u.length;i++){if(u[i].length===0){u.splice(i,1);}}for(i=0;i<c.aItems.length;i++){g=c.aItems[i].getFileName();if(c.aItems[i]._status===U._uploadingStatus&&u.indexOf(g)){u.push(g);}}f=new sap.m.List({});u.forEach(function(I){L=new sap.m.StandardListItem({title:I,icon:c._getIconFromFilename(I)});f.addAggregation("items",L,true);});d=new sap.m.Dialog({title:this._oRb.getText("UPLOADCOLLECTION_TERMINATE_TITLE"),content:[new sap.m.Text({text:this._oRb.getText("UPLOADCOLLECTION_TERMINATE_TEXT")}),f],buttons:[new sap.m.Button({text:this._oRb.getText("UPLOADCOLLECTION_OKBUTTON_TEXT"),press:function(){u=c._splitString2Array(c._getFileUploader().getProperty("value"),c);for(i=0;i<u.length;i++){for(j=0;j<c.aItems.length;j++){if(u[i]===c.aItems[j].getFileName()&&c.aItems[j]._status===U._displayStatus){c.fireFileDeleted({documentId:c.aItems[j].getDocumentId()});c.aItems[j]._status=U._toBeDeletedStatus;break;}else if(u[i]===c.aItems[j].getFileName()&&c.aItems[j]._status===U._uploadingStatus){c.aItems[j]._status=U._toBeDeletedStatus;break;}}}c._getFileUploader().abort();c.invalidate();d.close();}}),new sap.m.Button({text:this._oRb.getText("UPLOADCOLLECTION_CANCELBUTTON_TEXT"),press:function(){d.close();}})],styleClass:s});d.open();};U.prototype._handleEdit=function(e,i){if(this.sErrorState!=="Error"){i._status="Edit";this.editModeItem=e.getSource().getId().split("-editButton")[0];}this.invalidate();};U.prototype._handleClick=function(e,c,s){if(e.target.id.lastIndexOf("editButton")>0){sap.m.UploadCollection.prototype._handleOk(e,c,s,false);}else if(e.target.id.lastIndexOf("cancelButton")>0){sap.m.UploadCollection.prototype._handleCancel(e,c,s);}else if(e.target.id.lastIndexOf("ia_imageHL")<0&&e.target.id.lastIndexOf("ia_iconHL")<0&&e.target.id.lastIndexOf("deleteButton")<0&&e.target.id.lastIndexOf("ta_editFileName-inner")<0){if(e.target.id.lastIndexOf("cli")>0){c.sFocusId=e.target.id;}sap.m.UploadCollection.prototype._handleOk(e,c,s,true);}};U.prototype._handleOk=function(e,c,s,t){var T=true;var E=document.getElementById(s+"-ta_editFileName-inner");var n;var S=s.split("-").pop();var o=c.aItems[S].getProperty("fileName");var f=U.prototype._splitFilename(o);var i=sap.ui.getCore().byId(s+"-ta_editFileName");var d=c.aItems[S].errorState;var g=c.aItems[S].changedFileName;if(E!==null){n=E.value.replace(/^\s+/,"");}var h=e.srcControl?e.srcControl.getId().split("-"):e.oSource.getId().split("-");h=h.slice(0,3);c.sFocusId=h.join("-")+"-cli";if(n&&(n.length>0)){c.aItems[S]._status=U._displayStatus;if(f.name!==n){if(!c.getSameFilenameAllowed()){if(sap.m.UploadCollection.prototype._checkDoubleFileName(n+f.extension,c.aItems)){i.setProperty("valueState","Error",true);c.aItems[S]._status="Edit";c.aItems[S].errorState="Error";c.aItems[S].changedFileName=n;c.sErrorState="Error";T=false;if(d!=="Error"||g!==n){c.invalidate();}}else{i.setProperty("valueState","None",true);c.aItems[S].errorState=null;c.aItems[S].changedFileName=null;c.sErrorState=null;c.editModeItem=null;if(t){c.invalidate();}}}if(T){c._oItemForRename=c.aItems[S];c._onEditItemOk.bind(c)(n+f.extension);}}else{c.sErrorState=null;c.aItems[S].errorState=null;c.editModeItem=null;if(t){c.invalidate();}}}else{c.aItems[S]._status="Edit";c.aItems[S].errorState="Error";c.aItems[S].changedFileName=n;c.sErrorState="Error";if(d!=="Error"||g!==n){c.aItems[S].invalidate();}}};U.prototype._onEditItemOk=function(n){if(this._oItemForRename){this._oItemForRename.setFileName(n);this.fireFileRenamed({documentId:this._oItemForRename.getProperty("documentId"),fileName:n,item:this._oItemForRename});}delete this._oItemForRename;};U.prototype._handleCancel=function(e,c,s){var S=s.split("-").pop();c.aItems[S]._status=U._displayStatus;c.aItems[S].errorState=null;c.aItems[S].changedFileName=sap.ui.getCore().byId(s+"-ta_editFileName").getProperty("value");c.sFocusId=c.editModeItem+"-cli";c.sErrorState=null;c.editModeItem=null;c.invalidate();};U.prototype._onChange=function(e){if(e){var t=this;var r,c,i,f,I,s,d,A;this._cAddItems=0;if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9){var n=e.getParameter("newValue");if(!n){return;}f=n.split(/\" "/)[0];if(f.length===0){return;}}else{c=e.getParameter("files").length;if(c===0){return;}this._oFileUploader.removeAllHeaderParameters();this.removeAggregation("headerParameters",true);}this._oFileUploader.removeAllParameters();this.removeAllParameters();if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9){var o={name:e.getParameter("newValue")};var p={files:[o]};this.fireChange({getParameter:function(g){if(g==="files"){return[o];}},getParameters:function(){return p;},mParameters:p,files:[o]});}else{this.fireChange({getParameter:function(g){if(g){return e.getParameter(g);}},getParameters:function(){return e.getParameters();},mParameters:e.getParameters(),files:e.getParameter("files")});}var P=this.getAggregation("parameters");if(P){q.each(P,function(g,j){var k=new sap.ui.unified.FileUploaderParameter({name:j.getProperty("name"),value:j.getProperty("value")});t._oFileUploader.addParameter(k);});}if(!this.getInstantUpload()){s=U._pendingUploadStatus;}else{s=U._uploadingStatus;}if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9){I=new sap.m.UploadCollectionItem({fileName:f});if(!this.getInstantUpload()){I.setAssociation("fileUploader",this._oFileUploader,true);this.insertItem(I);this._aFileUploadersForPendingUpload.push(this._oFileUploader);}else{I._percentUploaded=0;}this.aItems.unshift(I);this._cAddItems++;}else{this._requestIdValue=this._requestIdValue+1;r=this._requestIdValue.toString();var h=this.getAggregation("headerParameters");for(i=0;i<c;i++){I=new sap.m.UploadCollectionItem({fileName:e.getParameter("files")[i].name});I._status=s;I._requestIdName=r;if(!this.getInstantUpload()){I.setAssociation("fileUploader",this._oFileUploader,true);d=this._oFormatDecimal.format(e.getParameter("files")[i].size);A=new O({text:d});I.insertAggregation("attributes",A,true);this.insertItem(I);this._aFileUploadersForPendingUpload.push(this._oFileUploader);}else{I._percentUploaded=0;}this.aItems.unshift(I);this._cAddItems++;}if(h){q.each(h,function(g,j){t._oFileUploader.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:j.getProperty("name"),value:j.getProperty("value")}));});}t._oFileUploader.addHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:this._requestIdName,value:r}));}}};U.prototype._onFilenameLengthExceed=function(e){var f={name:e.getParameter("fileName")};var c=[f];this.fireFilenameLengthExceed({getParameter:function(p){if(p){return e.getParameter(p);}},getParameters:function(){return e.getParameters();},mParameters:e.getParameters(),files:c});};U.prototype._onFileSizeExceed=function(e){if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9){var f=e.getParameter("newValue");var o={name:f};var p={newValue:f,files:[o]};this.fireFileSizeExceed({getParameter:function(P){if(P==="files"){return[o];}else if(P==="newValue"){return f;}},getParameters:function(){return p;},mParameters:p,files:[o]});}else{var o={name:e.getParameter("fileName"),fileSize:e.getParameter("fileSize")};this.fireFileSizeExceed({getParameter:function(P){if(P){return e.getParameter(P);}},getParameters:function(){return e.getParameters();},mParameters:e.getParameters(),files:[o]});}};U.prototype._onTypeMissmatch=function(e){var f={name:e.getParameter("fileName"),fileType:e.getParameter("fileType"),mimeType:e.getParameter("mimeType")};var c=[f];this.fireTypeMissmatch({getParameter:function(p){if(p){return e.getParameter(p);}},getParameters:function(){return e.getParameters();},mParameters:e.getParameters(),files:c});};U.prototype._onUploadTerminated=function(e){if(e){var i;var r=this._getRequestId(e);var f=e.getParameter("fileName");var c=this.aItems.length;for(i=0;i<c;i++){if(this.aItems[i]===f&&this.aItems[i]._requestIdName===r&&this.aItems[i]._status===U._uploadingStatus){this.aItems.splice(i,1);this.removeItem(i);break;}}this.fireUploadTerminated();}};U.prototype._onUploadComplete=function(e){if(e){var i,r,u,c;r=this._getRequestId(e);u=e.getParameter("fileName");if(!u){var d=(e.getSource().getProperty("value")).split(/\" "/);u=d[0];}c=this.aItems.length;for(i=0;i<c;i++){if(!r){if(this.aItems[i].getProperty("fileName")===u&&this.aItems[i]._status===U._uploadingStatus){this.aItems[i]._percentUploaded=100;this.aItems[i]._status=U._displayStatus;break;}}else if(this.aItems[i].getProperty("fileName")===u&&this.aItems[i]._requestIdName===r&&this.aItems[i]._status===U._uploadingStatus){this.aItems[i]._percentUploaded=100;this.aItems[i]._status=U._displayStatus;break;}}this.fireUploadComplete({getParameter:e.getParameter,getParameters:e.getParameters,mParameters:e.getParameters(),files:[{fileName:e.getParameter("fileName"),responseRaw:e.getParameter("responseRaw"),reponse:e.getParameter("response"),status:e.getParameter("status"),headers:e.getParameter("headers")}]});}};U.prototype._onUploadProgress=function(e){if(e){var i,u,p,P,r,c,o;u=e.getParameter("fileName");r=this._getRequestId(e);P=Math.round(e.getParameter("loaded")/e.getParameter("total")*100);if(P===100){P=P-1;}p=this._oRb.getText("UPLOADCOLLECTION_UPLOADING",[P]);c=this.aItems.length;for(i=0;i<c;i++){if(this.aItems[i].getProperty("fileName")===u&&this.aItems[i]._requestIdName==r&&this.aItems[i]._status===U._uploadingStatus){o=sap.ui.getCore().byId(this.aItems[i].getId()+"-ta_progress");if(!!o){o.setText(p);this.aItems[i]._percentUploaded=P;break;}}}}};U.prototype._getRequestId=function(e){var h;h=e.getParameter("requestHeaders");if(!h){return null;}for(var j=0;j<h.length;j++){if(h[j].name==this._requestIdName){return h[j].value;}}};U.prototype._getFileUploader=function(){var t=this,u=this.getInstantUpload();if(!u||!this._oFileUploader){var s=(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9)?false:true;this._iFUCounter=this._iFUCounter+1;var m=!u?false:this.getMultiple();this._oFileUploader=new sap.ui.unified.FileUploader(this.getId()+"-"+this._iFUCounter+"-uploader",{buttonOnly:true,buttonText:" ",enabled:this.getUploadEnabled(),fileType:this.getFileType(),icon:"sap-icon://add",iconFirst:false,maximumFilenameLength:this.getMaximumFilenameLength(),maximumFileSize:this.getMaximumFileSize(),mimeType:this.getMimeType(),multiple:m,name:"uploadCollection",uploadOnChange:u,sameFilenameAllowed:true,uploadUrl:this.getUploadUrl(),useMultipart:false,sendXHR:s,change:function(e){t._onChange(e);},filenameLengthExceed:function(e){t._onFilenameLengthExceed(e);},fileSizeExceed:function(e){t._onFileSizeExceed(e);},typeMissmatch:function(e){t._onTypeMissmatch(e);},uploadAborted:function(e){t._onUploadTerminated(e);},uploadComplete:function(e){t._onUploadComplete(e);},uploadProgress:function(e){t._onUploadProgress(e);}});var T=this._oFileUploader.getTooltip();if(!T&&!sap.ui.Device.browser.msie){this._oFileUploader.setTooltip(" ");}}return this._oFileUploader;};U.prototype._getIconFromFilename=function(f){var s=this._splitFilename(f).extension;if(q.type(s)==="string"){s=s.toLowerCase();}switch(s){case'.bmp':case'.jpg':case'.jpeg':case'.png':return U._placeholderCamera;case'.csv':case'.xls':case'.xlsx':return'sap-icon://excel-attachment';case'.doc':case'.docx':case'.odt':return'sap-icon://doc-attachment';case'.pdf':return'sap-icon://pdf-attachment';case'.ppt':case'.pptx':return'sap-icon://ppt-attachment';case'.txt':return'sap-icon://document-text';default:return'sap-icon://document';}};U.prototype._getThumbnail=function(t,f){if(t){return t;}else{return this._getIconFromFilename(f);}};U.prototype._triggerLink=function(e,c){var L=null;var i;if(c.editModeItem){sap.m.UploadCollection.prototype._handleOk(e,c,c.editModeItem,true);if(c.sErrorState==="Error"){return this;}c.sFocusId=e.getParameter("id");}i=e.oSource.getId().split("-");L=i[i.length-2];sap.m.URLHelper.redirect(c.aItems[L].getProperty("url"),true);};U.prototype.onkeydown=function(e){switch(e.keyCode){case q.sap.KeyCodes.F2:sap.m.UploadCollection.prototype._handleF2(e,this);break;case q.sap.KeyCodes.ESCAPE:sap.m.UploadCollection.prototype._handleESC(e,this);break;case q.sap.KeyCodes.DELETE:sap.m.UploadCollection.prototype._handleDEL(e,this);break;case q.sap.KeyCodes.ENTER:sap.m.UploadCollection.prototype._handleENTER(e,this);break;default:return;}e.setMarked();};U.prototype._setFocusAfterDeletion=function(D,c){if(!D){return;}var L=c.aItems.length;var s=null;if(L===0){var f=q.sap.byId(c._oFileUploader.sId);var o=f.find(":button");q.sap.focus(o);}else{var i=D.split("-").pop();if((L-1)>=i){s=D+"-cli";}else{s=c.aItems.pop().sId+"-cli";}sap.m.UploadCollection.prototype._setFocus2LineItem(s);}};U.prototype._setFocus2LineItem=function(f){if(!f){return;}var $=q.sap.byId(f);q.sap.focus($);};U.prototype._handleENTER=function(e,c){var t;var L;var o;if(c.editModeItem){t=e.target.id.split(c.editModeItem).pop();}else{t=e.target.id.split("-").pop();}switch(t){case"-ta_editFileName-inner":case"-okButton":sap.m.UploadCollection.prototype._handleOk(e,c,c.editModeItem,true);break;case"-cancelButton":e.preventDefault();sap.m.UploadCollection.prototype._handleCancel(e,c,c.editModeItem);break;case"-ia_iconHL":case"-ia_imageHL":var i=c.editModeItem.split("-").pop();sap.m.URLHelper.redirect(c.aItems[i].getProperty("url"),true);break;case"ia_iconHL":case"ia_imageHL":case"cli":L=e.target.id.split(t)[0]+"ta_filenameHL";o=sap.ui.getCore().byId(L);if(o.getEnabled()){var i=e.target.id.split("-")[2];sap.m.URLHelper.redirect(c.aItems[i].getProperty("url"),true);}break;default:return;}};U.prototype._handleDEL=function(e,c){if(!c.editModeItem){var o=q.sap.byId(e.target.id);var d=o.find("[id$='-deleteButton']");var D=sap.ui.getCore().byId(d[0].id);D.firePress();}};U.prototype._handleESC=function(e,c){if(c.editModeItem){c.sFocusId=c.editModeItem+"-cli";c.aItems[c.editModeItem.split("-").pop()]._status=U._displayStatus;sap.m.UploadCollection.prototype._handleCancel(e,c,c.editModeItem);}};U.prototype._handleF2=function(e,c){var o=sap.ui.getCore().byId(e.target.id);var d=q.sap.byId(e.target.id);if(o!==undefined){if(o._status==U._displayStatus){d=q.sap.byId(e.target.id);var f=d.find("[id$='-editButton']");var E=sap.ui.getCore().byId(f[0].id);if(E.getEnabled()){if(c.editModeItem){sap.m.UploadCollection.prototype._handleClick(e,c,c.editModeItem);}if(c.sErrorState!=="Error"){E.firePress();}}}else{sap.m.UploadCollection.prototype._handleClick(e,c,c.editModeItem);}}else{if(e.target.id.search(c.editModeItem)===0){sap.m.UploadCollection.prototype._handleOk(e,c,c.editModeItem,true);}}};U.prototype._splitString2Array=function(s,c){if(c.getMultiple()===true&&!(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version<=9)){s=s.substring(1,s.length-2);}return s.split(/\" "/);};U.prototype._checkDoubleFileName=function(f,I){if(I.length===0||!f){return false;}var L=I.length;f=f.replace(/^\s+/,"");for(var i=0;i<L;i++){if(f==I[i].getProperty("fileName")){return true;}}return false;};U.prototype._splitFilename=function(f){var r={};var n=f.split(".");if(n.length==1){r.extension="";r.name=n.pop();return r;}r.extension="."+n.pop();r.name=n.join(".");return r;};return U;},true);
